<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GLM and regularization tutorial using TCGA tumor gene expression data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="GLM_tutorial_files/libs/clipboard/clipboard.min.js"></script>
<script src="GLM_tutorial_files/libs/quarto-html/quarto.js"></script>
<script src="GLM_tutorial_files/libs/quarto-html/popper.min.js"></script>
<script src="GLM_tutorial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="GLM_tutorial_files/libs/quarto-html/anchor.min.js"></script>
<link href="GLM_tutorial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="GLM_tutorial_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="GLM_tutorial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="GLM_tutorial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="GLM_tutorial_files/libs/bootstrap/bootstrap-c0367b04c37547644fece4185067e4a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="GLM_tutorial_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="GLM_tutorial_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#part-1-building-on-linear-models-when-olms-fall-short" id="toc-part-1-building-on-linear-models-when-olms-fall-short" class="nav-link active" data-scroll-target="#part-1-building-on-linear-models-when-olms-fall-short">Part 1: Building on Linear Models: When OLMs Fall Short</a>
  <ul class="collapse">
  <li><a href="#when-biology-breaks-olm-assumptions" id="toc-when-biology-breaks-olm-assumptions" class="nav-link" data-scroll-target="#when-biology-breaks-olm-assumptions"><br>When Biology Breaks OLM Assumptions</a></li>
  </ul></li>
  <li><a href="#part-2-enter-generalized-linear-models-glms" id="toc-part-2-enter-generalized-linear-models-glms" class="nav-link" data-scroll-target="#part-2-enter-generalized-linear-models-glms"><br>Part 2: Enter Generalized Linear Models (GLMs)</a>
  <ul class="collapse">
  <li><a href="#the-glm-framework-three-components" id="toc-the-glm-framework-three-components" class="nav-link" data-scroll-target="#the-glm-framework-three-components">The GLM Framework: Three Components</a></li>
  <li><a href="#key-insight-glms-transform-the-mean-not-the-data" id="toc-key-insight-glms-transform-the-mean-not-the-data" class="nav-link" data-scroll-target="#key-insight-glms-transform-the-mean-not-the-data">Key Insight: GLMs Transform the Mean, Not the Data</a></li>
  </ul></li>
  <li><a href="#part-3-tutorial-with-tcga-breast-cancer-data" id="toc-part-3-tutorial-with-tcga-breast-cancer-data" class="nav-link" data-scroll-target="#part-3-tutorial-with-tcga-breast-cancer-data"><br>Part 3: Tutorial with TCGA Breast Cancer data</a>
  <ul class="collapse">
  <li><a href="#introduction-our-research-goals" id="toc-introduction-our-research-goals" class="nav-link" data-scroll-target="#introduction-our-research-goals">Introduction: Our Research Goals</a></li>
  <li><a href="#why-glms-will-be-essential-for-achieving-these-goals" id="toc-why-glms-will-be-essential-for-achieving-these-goals" class="nav-link" data-scroll-target="#why-glms-will-be-essential-for-achieving-these-goals">Why GLMs will be essential for achieving these goals</a></li>
  <li><a href="#analysis-part-1-load-required-libraries-and-access-tcga-database" id="toc-analysis-part-1-load-required-libraries-and-access-tcga-database" class="nav-link" data-scroll-target="#analysis-part-1-load-required-libraries-and-access-tcga-database"><br>Analysis part 1: Load Required Libraries and access TCGA database</a></li>
  <li><a href="#analysis-part-2-define-key-cancer-genes-and-create-a-dataset-the-combines-gene-expression-levels-and-patient-metadata" id="toc-analysis-part-2-define-key-cancer-genes-and-create-a-dataset-the-combines-gene-expression-levels-and-patient-metadata" class="nav-link" data-scroll-target="#analysis-part-2-define-key-cancer-genes-and-create-a-dataset-the-combines-gene-expression-levels-and-patient-metadata"><br>Analysis part 2: Define key cancer genes and create a dataset the combines gene expression levels and patient metadata</a></li>
  <li><a href="#analysis-part-3-exploratory-analysis-of-our-data" id="toc-analysis-part-3-exploratory-analysis-of-our-data" class="nav-link" data-scroll-target="#analysis-part-3-exploratory-analysis-of-our-data"><br>Analysis part 3: Exploratory analysis of our data</a></li>
  <li><a href="#analysis-part-4-does-pgr-expression-level-predict-tumor-aggression" id="toc-analysis-part-4-does-pgr-expression-level-predict-tumor-aggression" class="nav-link" data-scroll-target="#analysis-part-4-does-pgr-expression-level-predict-tumor-aggression"><br>Analysis part 4: Does pgr expression level predict tumor aggression?</a></li>
  <li><a href="#analysis-part-5-does-a-model-that-incorporates-all-6-key-genes-predict-tumor-status-better" id="toc-analysis-part-5-does-a-model-that-incorporates-all-6-key-genes-predict-tumor-status-better" class="nav-link" data-scroll-target="#analysis-part-5-does-a-model-that-incorporates-all-6-key-genes-predict-tumor-status-better"><br> Analysis part 5: Does a model that incorporates all 6 key genes predict tumor status better?</a></li>
  <li><a href="#analysis-part-6-does-a-model-that-incorporates-100-genes-fit-the-data-better" id="toc-analysis-part-6-does-a-model-that-incorporates-100-genes-fit-the-data-better" class="nav-link" data-scroll-target="#analysis-part-6-does-a-model-that-incorporates-100-genes-fit-the-data-better"><br>Analysis part 6: Does a model that incorporates 100+ genes fit the data better?</a></li>
  <li><a href="#analysis-part-7-can-regularization-methods-improve-model-performance" id="toc-analysis-part-7-can-regularization-methods-improve-model-performance" class="nav-link" data-scroll-target="#analysis-part-7-can-regularization-methods-improve-model-performance"><br>Analysis part 7: Can regularization methods improve model performance?</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">GLM and regularization tutorial using TCGA tumor gene expression data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><br></p>
<section id="part-1-building-on-linear-models-when-olms-fall-short" class="level2">
<h2 class="anchored" data-anchor-id="part-1-building-on-linear-models-when-olms-fall-short">Part 1: Building on Linear Models: When OLMs Fall Short</h2>
<p>In the previous tutorial, we explored Ordinary Linear Models (OLMs) and learned that they dominate statistics because of their mathematical guarantees, computational efficiency, and interpretability. We also saw how linear models can handle complex relationships through transformations, polynomials, and interactions.</p>
<p>All of the above is true, yet we must also acknowledge that OLMs make several fundamental assumptions that don’t hold for many types of biological and genomic data:</p>
<ol type="1">
<li><p><strong>Continuous response variables</strong>: OLMs assume your outcome can take any real value (e.g.&nbsp;not range bound or restricted to integers)</p></li>
<li><p><strong>Normal error distribution</strong>: Residuals follow a normal distribution</p></li>
<li><p><strong>Constant variance</strong>: The variance of residual values is the same across all fitted values</p></li>
<li><p><strong>Linear relationship</strong>: After transformations, the relationship should be linear in parameters</p></li>
</ol>
<p>There are many scenarios in which they assumptions hold true and OLMs are a valid analysis tool. In biological and genetic data however, there are multiple scenarios in which these assumptions are clearly violated.</p>
<section id="when-biology-breaks-olm-assumptions" class="level3">
<h3 class="anchored" data-anchor-id="when-biology-breaks-olm-assumptions"><br>When Biology Breaks OLM Assumptions</h3>
<section id="count-data-the-rna-seq-problem" class="level4">
<h4 class="anchored" data-anchor-id="count-data-the-rna-seq-problem">Count Data: The RNA-seq problem</h4>
<p>Imagine you’re analyzing RNA-seq data, where you measure gene expression as integer values. This integer count-based data has several properties that break OLM assumptions:</p>
<ul>
<li><p><strong>Discrete values (non-continuous)</strong>: You can’t have 2.5 reads</p></li>
<li><p><strong>Non-negative</strong>: Negative counts are impossible</p></li>
<li><p><strong>Variance increases with the mean</strong>: RNA-seq count data is inherently heteroscedastic, with higher-expressed genes having greater variance among replicates than low-expressed genes. This variability comes from a combination of biological variation between cells/populations, variance in library prep, and non-perfect read count normalization.</p></li>
<li><p><strong>Many zeros</strong>: Especially for lowly expressed genes</p></li>
</ul>
</section>
<section id="binary-outcomes-in-genome-wide-association-studies-gwas-analysis" class="level4">
<h4 class="anchored" data-anchor-id="binary-outcomes-in-genome-wide-association-studies-gwas-analysis"><br>Binary outcomes in genome-wide association studies (GWAS) analysis</h4>
<p>In GWAS, you want to predict probabilities of a specific outcome (disease) but your observations are binary (either disease or not disease). Other examples could be:</p>
<ul>
<li><p>P(treatment response | mutation_status)</p></li>
<li><p>P(mutation | population_ancestry)</p></li>
</ul>
<p>This violates OLM assumptions because:</p>
<ul>
<li><p><strong>Observed values are discrete:</strong> Only 0 or 1, not continuous</p></li>
<li><p><strong>Non-constant variance:</strong> The variance of binary outcomes is p(1-p), so it’s highest when probability ≈ 0.5 and lowest near 0 or 1</p></li>
<li><p><strong>Bounded predictions:</strong> We want probabilities between 0 and 1, but OLMs can predict any value (including negative “probabilities” or values &gt; 1)</p></li>
</ul>
</section>
<section id="survival-data-the-clinical-trial-problem" class="level4">
<h4 class="anchored" data-anchor-id="survival-data-the-clinical-trial-problem"><br>Survival Data: The Clinical Trial Problem</h4>
<p>Survival analysis studies the time until an event occurs. Despite the name “survival,” the “event” doesn’t have to be death - it could be:</p>
<ul>
<li><p>Time until cancer recurrence</p></li>
<li><p>Time until treatment failure</p></li>
<li><p>Time until infection clearance</p></li>
</ul>
<p>For example, in a cancer drug trial, you follow 100 patients for 5 years to see how long the treatment keeps their cancer in remission. In survival analysis, you’re often interested in hazard rates (instantaneous risk of failure) rather than just predicting time-to-event, which requires specialized modeling. For example, you might want to know what is the risk that a patient’s cancer returns in the next moment. This probability will change over the course of time e.g.&nbsp;the hazard rate may initially be high after treatment (non-responders), then lower for a while the treatment is effective, then higher again as the effects of the treatment wear off.</p>
<p>Survival data creates unique challenges:</p>
<ul>
<li><p><strong>Censoring</strong>: The study ends before some patients experience the event. Patient A is still cancer-free after 5 years - did the treatment “cure” them, or would they relapse in year 6? We don’t know.</p></li>
<li><p><strong>Bounded at zero:</strong> Survival times can’t be negative</p></li>
<li><p><strong>Time-varying risk</strong>: The risk of recurrence might change over time (high initially, then decrease, then increase again)</p></li>
</ul>
<p>The three challenges create situations that OLMs are not well equipped to handle.</p>
</section>
</section>
</section>
<section id="part-2-enter-generalized-linear-models-glms" class="level2">
<h2 class="anchored" data-anchor-id="part-2-enter-generalized-linear-models-glms"><br>Part 2: Enter Generalized Linear Models (GLMs)</h2>
<p>GLMs extend linear models to handle the above scenarios by relaxing key assumptions while maintaining the linear model framework we are familiar with.</p>
<section id="the-glm-framework-three-components" class="level3">
<h3 class="anchored" data-anchor-id="the-glm-framework-three-components">The GLM Framework: Three Components</h3>
<p>Every GLM consists of three components:</p>
<ol type="1">
<li><strong>The outcome distribution family</strong> : Specifies the probability distribution of the response variable</li>
<li><strong>The systematic component</strong>: The linear predictor (just like in OLMs): η = β₀ + β₁X₁ + β₂X₂ + …</li>
<li><strong>The link function</strong>: Connects the expected value of Y to the linear predictor: g(μ) = η. In other words, it transforms the continuous output of the linear predictors to conform to the outcome distribution family.</li>
</ol>
<p>It might seem that the link function and the outcome distribution family are really two sides of the same component, since the link function essentially defines the outcome distribution. This is not incorrect, however there are instances beyond the scope of this tutorial where it can be valuable to think of them as separate components. For example, you can have multiple different link functions that each transform data that conforms to the same outcome distribution.</p>
<p>In practice however, each outcome distribution family is frequently associated with a specific link function:</p>
<ul>
<li><p><strong>Binomial</strong> → logit link (99% of the time)</p></li>
<li><p><strong>Poisson</strong> → log link (99% of the time)</p></li>
<li><p><strong>Negative Binomial</strong> → log link (99% of the time)</p></li>
<li><p><strong>Normal</strong> → identity link (this just means the expected value of the outcome equals the linear predictor directly. This is what OLMs use and is the easiest to interpret)</p></li>
<li><p><strong>Gamma</strong> → log link (most common, ~80% of the time)</p></li>
</ul>
<p>You may wonder, how can the same link function (e.g.&nbsp;the log link) be associated with different outcome distributions? The reason is that the linear predictor and the link only predict the expected mean value. However the outcome distribution determines the shape of the expected variance around that mean.</p>
<p>When a GLM is fit, the algorithm will determine the regression coefficients (β₀, β₁, etc.) that determine the mean expected value as well as any distribution specific parameters that control the stucture of the expected variance around the mean. For example, given the following outcome distributions:</p>
<p><strong>Poission outcome:</strong> No additional parameters needed, since mean = variance by definition.</p>
<p><strong>Negative Binomial outcome:</strong> A dispersion parameter, θ (theta), that controls overdispersion is estimated. In the negative binomial, variance = mean + (mean²/θ), which allows for much more variability than the Poisson.</p>
<p><strong>Gamma outcome:</strong> Estimates a shape parameter that controls the variance-to-mean relationship. Variance = mean²/shape, so variance increases with the square of the mean.</p>
<p><strong>Normal outcome:</strong> Estimates σ² (error variance), which is constant regardless of the mean value.</p>
</section>
<section id="key-insight-glms-transform-the-mean-not-the-data" class="level3">
<h3 class="anchored" data-anchor-id="key-insight-glms-transform-the-mean-not-the-data">Key Insight: GLMs Transform the Mean, Not the Data</h3>
<p>In OLMs, we sometimes transform the response variable (e.g., log(Y)) to meet assumptions. In GLMs, we transform the expected value of Y through the link function, while keeping the original outcome data intact. This is powerful because we maintain the original scale and interpretation of our data while allowing for predicted expected values to follow a specific distribution that may be different than the training data. For example, we can create a model that predicts P(disease | allele status) even if our training outcome data is binary (disease or not disease).</p>
</section>
</section>
<section id="part-3-tutorial-with-tcga-breast-cancer-data" class="level2">
<h2 class="anchored" data-anchor-id="part-3-tutorial-with-tcga-breast-cancer-data"><br>Part 3: Tutorial with TCGA Breast Cancer data</h2>
<section id="introduction-our-research-goals" class="level3">
<h3 class="anchored" data-anchor-id="introduction-our-research-goals">Introduction: Our Research Goals</h3>
<p>Let’s imagine you’re a cancer genomics researcher analyzing The Cancer Genome Atlas (TCGA) breast cancer cohort. Your team wants to understand the relationship between gene expression levels in tumors and whether those tumors are considered to be aggressive, or not.</p>
<p>Specifically, you want to determine:</p>
<ol type="1">
<li><p>Are there specific genes whose expression is highly correlated with whether a tumor is aggressive?</p></li>
<li><p>Can we build a statistical model that will help us reliably predict whether a tumor is aggressive or not based solely on gene expression data?</p></li>
</ol>
</section>
<section id="why-glms-will-be-essential-for-achieving-these-goals" class="level3">
<h3 class="anchored" data-anchor-id="why-glms-will-be-essential-for-achieving-these-goals">Why GLMs will be essential for achieving these goals</h3>
<ul>
<li><strong>Binary Clinical Outcomes</strong>: Through the use of the logit link, GLMs can predict binary outcomes, or probabilities between 0 and 1. GLMs will also be able to properly model the variance structure of the outcome distribution, which is not homoscedastic.</li>
</ul>
<p>Let’s get started!</p>
</section>
<section id="analysis-part-1-load-required-libraries-and-access-tcga-database" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-1-load-required-libraries-and-access-tcga-database"><br>Analysis part 1: Load Required Libraries and access TCGA database</h3>
<p><br><strong>Load necessary libraries</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(curatedTCGAData) <span class="co"># for access to TCGA</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidySummarizedExperiment) <span class="co"># containers for genomic data: stores expression/CNV metadata</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MultiAssayExperiment) <span class="co"># integrates multiple data types (expression + CNV + clinical)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom) <span class="co"># for tidy output of linear models</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC) <span class="co"># Calculates AUC, plos ROC curves for model analysis</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet) <span class="co"># For regularization (Ridge, Lasso, Elastic Net)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot) <span class="co"># for making correlation matrix plots</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap) </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcorrplot) <span class="co"># ggplot style correlation plots</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># for regex </span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(psych) <span class="co"># for pretty summary tables</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FSA) <span class="co"># for Dunn's test (note that it is instaleld as r-fsa, but loaded as FSA)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales) <span class="co"># get default ggplot colors</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret) <span class="co"># for cross validation</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car) <span class="co"># for running vif</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr) <span class="co"># for using annotate() with ggplots </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll now download our dataset from the curated TCGA data as an S4 object. Curated TCGA data has been preprocessed and cleaned to facilitate downsteam analysis. In contrast, raw TCGA data may be made up of multiple file formats, sample types, may have missing or inconsistent data, and may require normalization and batch correction.</p>
<p><br><strong>Download the curated breast cancer data from TCGA</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the Multi Assay Experiment associated with the BRCA object </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This will download normalized RNA-seq expression data, and clinical data from the BRCA dataset  </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>brca_mae <span class="ot">&lt;-</span> <span class="fu">curatedTCGAData</span>(<span class="st">"BRCA"</span>, <span class="at">assays =</span> <span class="fu">c</span>(<span class="st">"RNASeq2GeneNorm"</span>, <span class="st">"clinical"</span>), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">version =</span> <span class="st">"2.1.1"</span>, <span class="at">dry.run =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print experiment names</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dataset succesfully downloaded</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The names of the experiments are:"</span>, <span class="fu">names</span>(brca_mae), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above code will download the S4 object. S4 objects have:</p>
<ol type="1">
<li>Slots - named components that hold specific types of data</li>
<li>Classes - Blueprints that define which slots exist and what data types they can hold</li>
<li>Methods - Functions that work with specific S4 classes</li>
</ol>
<p>This specific S4 object we downloaded is of a MultiAssayExperiment class – a class designed specifically for multi-omics data. The key slots in a this type of class are:</p>
<ul>
<li><p>The experiments slot contains different data types from different experiments: brca_mae@ExperimentList</p></li>
<li><p>The colData slot has patient demographic and clinical information: brca_mae@colData</p></li>
<li><p>The sampleMap links samples across experiments by showing which samples belong to which patient: brca_mae@sampleMap</p></li>
</ul>
<p>The only data we care about now are the RNA-seq data and the patient metadata that we will use classify tumors and aggressive or not aggressive.</p>
<p><br><strong>Extract the RNA-seq data and patient metadata from brca_mae</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 'assay' is a method that extracts the data matrix from summarizedExperiment objects  </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>expression_data <span class="ot">&lt;-</span> <span class="fu">assay</span>(brca_mae[[<span class="st">"BRCA_RNASeq2GeneNorm-20160128"</span>]])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># In Bioconductor Objects, clinical data is accessed with colData</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>clinical_data <span class="ot">&lt;-</span> <span class="fu">colData</span>(brca_mae)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print description of objects</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Expression_data is a"</span>, <span class="fu">dim</span>(expression_data)[<span class="dv">1</span>], <span class="st">"by"</span>, <span class="fu">dim</span>(expression_data)[<span class="dv">2</span>], <span class="fu">class</span>(expression_data)[<span class="dv">1</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Columns are patients IDs and rows are gene names</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Clinical_data is a"</span>, <span class="fu">dim</span>(clinical_data)[<span class="dv">1</span>], <span class="st">"by"</span>, <span class="fu">dim</span>(clinical_data)[<span class="dv">2</span>], <span class="fu">class</span>(clinical_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rows are patients IDs and each row contains a list with metadata"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expression_data is a 18300 by 1212 matrix 
 Columns are patients IDs and rows are gene names
 Clinical_data is a 1093 by 2684 DFrame 
 Rows are patients IDs and each row contains a list with metadata</code></pre>
</div>
</div>
<p>It looks like the expression data has 1212 patients, while the clinical data has only 1093 patients. Let’s first get the subset of both of these datasets that corresponds to the common patients in both of them.</p>
<p><br><strong>Subset the data to include only patients in both the RNA-seq and clinical metadata objects</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get all patient ids with expression data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>expression_patients <span class="ot">&lt;-</span> <span class="fu">colnames</span>(expression_data)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use regular expression (stringer package) to get the short from of the patient ID that matches the IF format from the metadata metadata</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>expression_patients_succinct <span class="ot">&lt;-</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_extract</span>(expression_patients, <span class="st">"TCGA-[A-Z0-9]{2}-[A-Z0-9]{4}"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the columns of the expression data dataset </span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(expression_data) <span class="ot">&lt;-</span> expression_patients_succinct</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get the patient ids from the clinical data</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>clinical_patients <span class="ot">&lt;-</span> <span class="fu">rownames</span>(clinical_data)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># get the list of overlapping patient ids </span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>common_patients <span class="ot">&lt;-</span> <span class="fu">intersect</span>(clinical_patients, expression_patients_succinct)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># subset the expression data and clinical data in place</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>expression_data <span class="ot">&lt;-</span> expression_data[, common_patients]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>clinical_data <span class="ot">&lt;-</span> clinical_data[common_patients,]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"There are"</span>, <span class="fu">length</span>(common_patients), <span class="st">"common patients across the RNA-seq data and clinical metadata</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"expression_data is now a"</span>, <span class="fu">class</span>(expression_data), <span class="st">"with"</span>, <span class="fu">nrow</span>(expression_data), <span class="st">"rows and"</span>, <span class="fu">ncol</span>(expression_data), <span class="st">"columns</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"clinical_data is now a"</span>, <span class="fu">class</span>(clinical_data), <span class="st">"with"</span>, <span class="fu">nrow</span>(clinical_data), <span class="st">"rows and"</span>, <span class="fu">ncol</span>(clinical_data), <span class="st">"columns</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1093 common patients across the RNA-seq data and clinical metadata

 expression_data is now a matrix array with 18300 rows and 1093 columns
 clinical_data is now a DFrame with 1093 rows and 2684 columns</code></pre>
</div>
</div>
</section>
<section id="analysis-part-2-define-key-cancer-genes-and-create-a-dataset-the-combines-gene-expression-levels-and-patient-metadata" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-2-define-key-cancer-genes-and-create-a-dataset-the-combines-gene-expression-levels-and-patient-metadata"><br>Analysis part 2: Define key cancer genes and create a dataset the combines gene expression levels and patient metadata</h3>
<p>To get started with GLMs, we’ll first focus our analysis on a small set of genes known to be drivers of certain types of cancers. This will allow us to get comfortable with GLMs before we start building models that use the full dataset with expression levels of 1000+ genes.</p>
<p><br><strong>Define key cancer genes and extract expression data for them</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cancer_genes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ERBB2"</span>, <span class="st">"MYC"</span>,   <span class="co"># Oncogenes</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"TP53"</span>, <span class="st">"BRCA1"</span>,   <span class="co"># Tumor suppressors  </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"ESR1"</span>, <span class="st">"PGR"</span>)     <span class="co"># Hormone receptors</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>expr_subset <span class="ot">&lt;-</span> expression_data[cancer_genes,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><strong>Create a df that contains clinical data of interest to this analysis and gene expression levels of our key genes for each patient</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>analysis_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_id =</span> common_patients,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># deomgraphic info</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">as.numeric</span>(clinical_data<span class="sc">$</span>patient.age_at_initial_pathologic_diagnosis),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># alive or dead</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vital_status =</span> <span class="fu">ifelse</span>(clinical_data<span class="sc">$</span>patient.vital_status <span class="sc">==</span> <span class="st">"dead"</span>, <span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># days from diagnosis to death </span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">days_to_death  =</span> <span class="fu">as.numeric</span>(clinical_data<span class="sc">$</span>patient.days_to_death), </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># days from diagnosis to last contact</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">days_to_last_followup =</span> <span class="fu">as.numeric</span>(clinical_data<span class="sc">$</span>patient.days_to_last_followup), </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tumor characteristics</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> clinical_data<span class="sc">$</span>pathologic_stage,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># do the cells have estrogen receptors</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">er_status =</span> clinical_data<span class="sc">$</span>patient.breast_carcinoma_estrogen_receptor_status,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># do the cells have progesterone receptors</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">pr_status =</span> clinical_data<span class="sc">$</span>patient.breast_carcinoma_estrogen_receptor_status, </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># gene expression data</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">erbb2_expr =</span> expr_subset[<span class="st">"ERBB2"</span>, ],</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">tp53_expr =</span> expr_subset[<span class="st">"TP53"</span>, ],</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">brca1_expr =</span> expr_subset[<span class="st">"BRCA1"</span>, ],</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">myc_expr =</span> expr_subset[<span class="st">"MYC"</span>, ],</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">esr1_expr =</span> expr_subset[<span class="st">"ESR1"</span>, ],</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">pgr_expr =</span> expr_subset[<span class="st">"PGR"</span>, ])</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Analysis_data is a"</span>, <span class="fu">nrow</span>(analysis_data), <span class="st">"by"</span>, <span class="fu">ncol</span>(analysis_data), <span class="fu">class</span>(analysis_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="st">"Row labels are patient IDs and columns contain metadata and gene expression levels"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis_data is a 1093 by 14 data.frame 
 Row labels are patient IDs and columns contain metadata and gene expression levels</code></pre>
</div>
</div>
<p>We are now going to define tumors as either ‘aggressive’, or ‘not-aggressive’. This binary outcome variable will be what we try to create a model to predict using GLMs in following sections of this tutorial. For our purposes, we will define aggressive tumors as those that are stage iii or stage iv tumors, or those that do not respond to either progesterone or estrogen hormones.</p>
<p><br><strong>Clean the stage variable, then define whether a tumor is aggressive or not</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>analysis_data <span class="ot">&lt;-</span> analysis_data <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out patient IDs missing or unrealistic ages</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(age), age <span class="sc">&gt;=</span> <span class="dv">18</span>, age <span class="sc">&lt;=</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make a survival time variable</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">survival_time =</span> <span class="fu">ifelse</span>(vital_status <span class="sc">==</span> <span class="dv">1</span>, days_to_death, days_to_last_followup), </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>         <span class="co"># simple catetogization for tumor status</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">stage_simple =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_detect</span>(stage, <span class="fu">regex</span>(<span class="st">"stage i[^iv]|stage i$"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)) <span class="sc">~</span> <span class="st">"Early"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_detect</span>(stage, <span class="fu">regex</span>(<span class="st">"stage ii[^i]|stage ii$"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)) <span class="sc">~</span> <span class="st">"Early"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_detect</span>(stage, <span class="fu">regex</span>(<span class="st">"stage iii"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)) <span class="sc">~</span> <span class="st">"Advanced"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_detect</span>(stage, <span class="fu">regex</span>(<span class="st">"stage iv"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)) <span class="sc">~</span> <span class="st">"Advanced"</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>           <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Unknown"</span>),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">stage_clean =</span> <span class="fu">str_extract</span>(stage, <span class="fu">regex</span>(<span class="st">"stage</span><span class="sc">\\</span><span class="st">s(iv|i{1,3})"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>         <span class="co"># define aggressive disease</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">aggressive_disease =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>           stage_simple <span class="sc">==</span> <span class="st">'Advanced'</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>           er_status <span class="sc">==</span> <span class="st">'negative'</span> <span class="sc">&amp;</span> pr_status <span class="sc">==</span> <span class="st">"negative"</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>           <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop unrealistic survivial times         </span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(survival_time), survival_time <span class="sc">&gt;</span> <span class="dv">0</span>, survival_time <span class="sc">&lt;</span> <span class="dv">50000</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start to get comforatble with the df we created that now contains both metadata and gene expression data.</p>
<p><br><strong>Show the structure of each column in the df</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(analysis_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   1040 obs. of  18 variables:
 $ patient_id           : chr  "TCGA-A1-A0SB" "TCGA-A1-A0SD" "TCGA-A1-A0SE" "TCGA-A1-A0SF" ...
 $ age                  : num  70 59 56 54 61 39 52 39 54 77 ...
 $ vital_status         : num  0 0 0 0 0 0 0 0 1 0 ...
 $ days_to_death        : num  NA NA NA NA NA NA NA NA 967 NA ...
 $ days_to_last_followup: num  259 437 1321 1463 434 ...
 $ stage                : chr  "stage i" "stage iia" "stage i" "stage iia" ...
 $ er_status            : chr  "positive" "positive" "positive" "positive" ...
 $ pr_status            : chr  "positive" "positive" "positive" "positive" ...
 $ erbb2_expr           : num  12.7 13.7 13.2 13 13.4 ...
 $ tp53_expr            : num  12.1 10.3 10.5 10.8 10.7 ...
 $ brca1_expr           : num  8.54 8.09 8.89 8.08 8.34 ...
 $ myc_expr             : num  12.92 11.11 11.07 10.8 8.77 ...
 $ esr1_expr            : num  9.75 13.25 12.11 12.95 14.01 ...
 $ pgr_expr             : num  3.24 9.49 12.81 12.79 13.87 ...
 $ survival_time        : num  259 437 1321 1463 434 ...
 $ stage_simple         : chr  "Early" "Early" "Early" "Early" ...
 $ stage_clean          : chr  "stage i" "stage ii" "stage i" "stage ii" ...
 $ aggressive_disease   : num  0 0 0 0 0 1 0 1 1 0 ...</code></pre>
</div>
</div>
<p>Many statistical steps require our data to either have no missing values, or to specify a method for working around them. At this stage let’s just get a sense for how many missing datapoints are in our df.</p>
<p><br><strong>Show the number of entries in each column that have missing data</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(analysis_data <span class="sc">%&gt;%</span> <span class="fu">summarise_all</span>(<span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   1 obs. of  18 variables:
 $ patient_id           : int 0
 $ age                  : int 0
 $ vital_status         : int 0
 $ days_to_death        : int 936
 $ days_to_last_followup: int 104
 $ stage                : int 8
 $ er_status            : int 39
 $ pr_status            : int 39
 $ erbb2_expr           : int 0
 $ tp53_expr            : int 0
 $ brca1_expr           : int 0
 $ myc_expr             : int 0
 $ esr1_expr            : int 0
 $ pgr_expr             : int 1
 $ survival_time        : int 0
 $ stage_simple         : int 0
 $ stage_clean          : int 22
 $ aggressive_disease   : int 0</code></pre>
</div>
</div>
<p>It’s also helpful to get a broad overview of the range and distribution of the variables in the df. Let’s look at some summary statistics.</p>
<p><br><strong>Show summary statistics for each of the numeric columns</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> analysis_data <span class="sc">%&gt;%</span> <span class="fu">select_if</span>(is.numeric) <span class="sc">%&gt;%</span> <span class="fu">describe</span>() <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>skew, <span class="sc">-</span>kurtosis, <span class="sc">-</span>vars, <span class="sc">-</span>trimmed, <span class="sc">-</span>mad)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(summary_stats, <span class="at">caption =</span> <span class="st">"Summary statistcs of TCGA dataset"</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<caption>Summary statistcs of TCGA dataset</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">min</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">max</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">range</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">58.43</td>
<td style="text-align: right;">13.19</td>
<td style="text-align: right;">58.00</td>
<td style="text-align: right;">26.00</td>
<td style="text-align: right;">90.00</td>
<td style="text-align: right;">64.00</td>
<td style="text-align: right;">0.41</td>
</tr>
<tr class="even">
<td style="text-align: left;">vital_status</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">days_to_death</td>
<td style="text-align: right;">104</td>
<td style="text-align: right;">1617.35</td>
<td style="text-align: right;">1098.51</td>
<td style="text-align: right;">1409.00</td>
<td style="text-align: right;">116.00</td>
<td style="text-align: right;">4456.00</td>
<td style="text-align: right;">4340.00</td>
<td style="text-align: right;">107.72</td>
</tr>
<tr class="even">
<td style="text-align: left;">days_to_last_followup</td>
<td style="text-align: right;">936</td>
<td style="text-align: right;">772.04</td>
<td style="text-align: right;">991.18</td>
<td style="text-align: right;">395.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7067.00</td>
<td style="text-align: right;">7066.00</td>
<td style="text-align: right;">32.40</td>
</tr>
<tr class="odd">
<td style="text-align: left;">erbb2_expr</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">12.88</td>
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">12.71</td>
<td style="text-align: right;">7.27</td>
<td style="text-align: right;">18.54</td>
<td style="text-align: right;">11.26</td>
<td style="text-align: right;">0.05</td>
</tr>
<tr class="even">
<td style="text-align: left;">tp53_expr</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">10.50</td>
<td style="text-align: right;">0.86</td>
<td style="text-align: right;">10.61</td>
<td style="text-align: right;">7.60</td>
<td style="text-align: right;">12.61</td>
<td style="text-align: right;">5.01</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brca1_expr</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">8.28</td>
<td style="text-align: right;">1.07</td>
<td style="text-align: right;">8.29</td>
<td style="text-align: right;">3.09</td>
<td style="text-align: right;">11.05</td>
<td style="text-align: right;">7.95</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="even">
<td style="text-align: left;">myc_expr</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">10.77</td>
<td style="text-align: right;">1.27</td>
<td style="text-align: right;">10.90</td>
<td style="text-align: right;">6.64</td>
<td style="text-align: right;">14.19</td>
<td style="text-align: right;">7.56</td>
<td style="text-align: right;">0.04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">esr1_expr</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">11.58</td>
<td style="text-align: right;">3.12</td>
<td style="text-align: right;">12.57</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">16.14</td>
<td style="text-align: right;">14.69</td>
<td style="text-align: right;">0.10</td>
</tr>
<tr class="even">
<td style="text-align: left;">pgr_expr</td>
<td style="text-align: right;">1039</td>
<td style="text-align: right;">9.07</td>
<td style="text-align: right;">3.36</td>
<td style="text-align: right;">9.77</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">16.48</td>
<td style="text-align: right;">17.03</td>
<td style="text-align: right;">0.10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">survival_time</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">856.57</td>
<td style="text-align: right;">1033.49</td>
<td style="text-align: right;">462.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7067.00</td>
<td style="text-align: right;">7066.00</td>
<td style="text-align: right;">32.05</td>
</tr>
<tr class="even">
<td style="text-align: left;">aggressive_disease</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.02</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>These data tell us that the median age of patients in the dataset is 58, but the range is from 26 to 90. Given the wide age rage, we should consider using this as a predictor in our model as it could have an impact on whether a tumor is aggressive or not. These data also show that 104 patients died during the course of the study. This is not immediately relevant to our analysis but good to generally be aware of.</p>
<p>One piece of information not contained in this table is how many of the patient’s tumors were categorized as aggressive or not aggressive. This is relevant to our analysis as if there are few patients that fall into either of these classes, our mode will struggle to identify variables that are predictive of that class. Furthermore, if e.g.&nbsp;95% of tumors are non-aggressive, our model may appear to be performing well even if it is just predicting that all tumors are non-aggressive. This type of challenge, called ‘class imbalance’ is pervasive in statistical modeling. Some rules of thumb to identify and manage it are:</p>
<p><strong>When to be concerned about class imbalance:</strong></p>
<ul>
<li><p>Minor concern: imbalance up to 70:30 splits are usually manageable</p></li>
<li><p>Moderate concern: 80:20 to 90:10 splits may need attention</p></li>
<li><p>Major concern: &gt;95:5 splits almost always require specific handling</p></li>
</ul>
<p><strong>Absolute sample size matters more than ratios:</strong></p>
<ul>
<li><p>&lt;50 samples in the minority class is problematic regardless of total sample size</p></li>
<li><p>200 minority class samples is usually sufficient even with moderate imbalance</p></li>
</ul>
<p><strong>Diagnostic steps:</strong></p>
<ul>
<li><p>Always examine class distribution before modeling</p></li>
<li><p>Focus on performance metrics for each class separately (sensitivity, specificity) rather than overall accuracy</p></li>
<li><p>Consider whether false negatives or false positives are more costly in your specific context</p></li>
</ul>
<p>Let’s check our dataset for class imbalance:</p>
<p><br><strong>Print the number of patients that have aggressive and non-aggressive tumors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 = aggressive, 0 = non-aggressive</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(analysis_data<span class="sc">$</span>aggressive_disease)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
599 441 </code></pre>
</div>
</div>
<p>Our split is fairly close to even and we have &gt; 200 patients in each class, so no need for us to worry about class imbalance in our analysis in our full dataset. If we end up sub-setting our dataset by patients in later analyses, we may want to revisit this question.</p>
<p>Let’s continue to an exploratory analysis of our data.</p>
</section>
<section id="analysis-part-3-exploratory-analysis-of-our-data" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-3-exploratory-analysis-of-our-data"><br>Analysis part 3: Exploratory analysis of our data</h3>
<p>Before getting into modeling, let’s first get a feel for the TCGA data and the relationships among different patient and tumor characteristics. First, we’ll visualize the distribution of expression levels of our key genes.</p>
<p><br><strong>Plot the gene expression distribution for key genes</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use str_detect to get only the columns whose name contains "_expr"</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>expr_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(analysis_data)[<span class="fu">str_detect</span>(<span class="fu">names</span>(analysis_data), <span class="st">"_expr"</span>)]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check to make sure these cols have data</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>available_expr_cols <span class="ot">&lt;-</span> expr_cols[<span class="sc">!</span><span class="fu">is.na</span>(analysis_data[<span class="dv">1</span>, expr_cols])]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># make a long df with just the expression data and patient IDs. </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># -patient_id tells the function to pivot all columns except patient_id</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>expr_long <span class="ot">&lt;-</span> analysis_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(patient_id, <span class="fu">all_of</span>(available_expr_cols)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>patient_id, <span class="at">names_to=</span> <span class="st">"gene"</span>, </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">'expression'</span>, <span class="at">names_pattern =</span> <span class="st">"(.*)_expr"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># make density plots</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(expr_long, <span class="fu">aes</span>(<span class="at">x=</span>expression, <span class="at">fill=</span>gene)) <span class="sc">+</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> .<span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> gene, <span class="at">scales=</span><span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">'log2 expression level'</span>, <span class="at">y =</span> <span class="st">'Density'</span>) <span class="sc">+</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The density plots show that there are some very large differences in expression levels in different patients. Some of the distributions even look bimodal, like pgr, esr1, and erbb2. Let’s now see if these gene expression values are correlated across patients, i.e.&nbsp;do certain forms of cancers create gene expression profiles in which multiple of these genes are either highly or lowly expressed together?</p>
<p><br><strong>Determine correlations between gene expression levels</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get gene expression columns and calculate correlation matrix</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>expr_matrix <span class="ot">&lt;-</span> <span class="fu">select</span>(analysis_data, <span class="fu">all_of</span>(expr_cols))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># complete.obs tells cor to only uses rows that have data for all variables being compared</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(expr_matrix, <span class="at">use=</span><span class="st">"complete.obs"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcorrplot</span>(corr_matrix, <span class="at">hc.order =</span> <span class="cn">TRUE</span>, <span class="at">lab =</span> <span class="cn">TRUE</span>, <span class="at">type=</span><span class="st">'upper'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows that esr1 (estrogen receptor gene) and pgr (progesterone receptor) expression are moderately correlated. This suggests that when we are modeling, we will likely need to address collinearity between pgr and esr1 expression levels. Let’s dig a bit deeper into the relationships between gene expression data and disease status to get a better feel for the data.</p>
<p><br><strong>Check for a relationship between gene expression levels and estrogen receptor status of the tumor.</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">select</span>(analysis_data, er_status, <span class="fu">all_of</span>(expr_cols)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="sc">-</span>er_status, <span class="at">names_to=</span><span class="st">"gene"</span>, <span class="at">values_to =</span> <span class="st">'expression'</span>, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_pattern =</span> <span class="st">"(.*)_expr"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(er_status), er_status <span class="sc">!=</span> <span class="st">'indeterminate'</span>) </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x=</span>er_status, <span class="at">y=</span>expression, <span class="at">fill=</span>gene)) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>() <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> gene) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">'log2 expression'</span>, <span class="at">x=</span><span class="st">'estrogen receptor(?)'</span>) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> median, <span class="at">geom =</span> <span class="st">"crossbar"</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fatten =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows that er negative tumors have lower levels of expression of the pgr and esr genes. This suggests that their lack of responsiveness to estrogen is due to reduced expression of the estrogen receptor gene, and that as we saw in the plot above, this is correlated with low pgr expression. Let’s confirm this by making analogous plots for response to progesterone.</p>
<p><br><strong>Plot gene expression levels and progesterone receptor status of the tumor.</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">select</span>(analysis_data, pr_status, <span class="fu">all_of</span>(expr_cols)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="sc">-</span>pr_status, <span class="at">names_to=</span><span class="st">"gene"</span>, <span class="at">values_to =</span> <span class="st">'expression'</span>, <span class="at">names_pattern =</span> <span class="st">"(.*)_expr"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pr_status), pr_status <span class="sc">!=</span> <span class="st">'indeterminate'</span>) </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x=</span>pr_status, <span class="at">y=</span>expression, <span class="at">fill=</span>gene)) <span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>() <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> gene) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">'log2 expression'</span>, <span class="at">x=</span><span class="st">'progesterone receptor(?)'</span>) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> median, <span class="at">geom =</span> <span class="st">"crossbar"</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fatten =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Indeed, a lack of responsiveness to progesterone is also associated with reduced expression of the pgr and esr1 genes, as expected. There does not appear to be an obvious relationship between response to either hormone and expression levels of other key genes.</p>
<p>To continue our exploratory analysis, let’s check for a relationship between gene expression levels and the stage of the tumor.</p>
<p><br><strong>Make plots to compare gene expression levels across different tumor stages</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">select</span>(analysis_data, stage_clean, <span class="fu">all_of</span>(expr_cols)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>stage_clean, <span class="at">names_to=</span> <span class="st">"gene"</span>, <span class="at">values_to =</span> <span class="st">"expression"</span>, <span class="at">names_pattern =</span> <span class="st">"(.*)_expr"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(stage_clean), stage_clean <span class="sc">!=</span> <span class="st">'stage x'</span>) </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x=</span>expression, <span class="at">y=</span>stage_clean, <span class="at">fill=</span>gene)) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>() <span class="sc">+</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>gene) <span class="sc">+</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> median, <span class="at">geom =</span> <span class="st">"crossbar"</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fatten =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">'log2 expression'</span>) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It’s pretty hard to see whether there are any significant relationships here. It looks like there may be one between pgr and stage but it’s impossible to tell with any certainty looking at this violin plot.</p>
<p>To actually answer this question, let’s use a Kruskal Wallis test (KWT). The KWT is a non-parametric test that determines whether the values for one variables are non-randomly distributed across the values of another variable. It is only applicable to instances when one variable is categorical and the other is numeric. It works by combining all of the gene expression values across all stage groups, then ranking them from 1 -&gt; # patients, then assigning the ranks back to each stage group. It will then determine whether the sums of ranks for each group deviate more than expected under a null distribution (which follows a Chi-Square). Some general guidelines for using this test:</p>
<ul>
<li><p>There should be at least 8 observations in each group</p></li>
<li><p>There should be at least 20 observations across all groups</p></li>
</ul>
<p>Since we want to perform this test on multiple genes, we will group the df by each gene and for each group perform the test.</p>
<p><br><strong>Run the KWT to test for non-random relationships between gene expression and tumor stage</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a table that contains the test results for each gene and how many tumors in each stage</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>kw_results <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gene) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_total =</span> <span class="fu">n</span>(),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stage_i =</span> <span class="fu">sum</span>(stage_clean <span class="sc">==</span> <span class="st">"stage i"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stage_ii =</span> <span class="fu">sum</span>(stage_clean <span class="sc">==</span> <span class="st">"stage ii"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stage_iii =</span> <span class="fu">sum</span>(stage_clean <span class="sc">==</span> <span class="st">"stage iii"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stage_iV =</span> <span class="fu">sum</span>(stage_clean <span class="sc">==</span> <span class="st">"stage iv"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># perfrom the test and create the kw_result object</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">kw_result =</span> <span class="fu">list</span>(<span class="fu">kruskal.test</span>(expression <span class="sc">~</span> stage_clean)), </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the KW test statistic </span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="fu">map_dbl</span>(kw_result, <span class="st">"statistic"</span>), </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the KW p-value</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> <span class="fu">map_dbl</span>(kw_result, <span class="st">"p.value"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove the kw_result object now that we've extracted the p-value and statistic</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>kw_result) <span class="sc">%&gt;%</span> </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(p_value) <span class="sc">%&gt;%</span> </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add an adjusted p-value column</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_adjust =</span> <span class="fu">p.adjust</span>(p_value, <span class="at">method =</span> <span class="st">"BH"</span>))</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(kw_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">statistic =</span> <span class="fu">round</span>(statistic, <span class="dv">2</span>), </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                          <span class="at">p_value =</span> <span class="fu">round</span>(p_value, <span class="dv">4</span>),</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>                          <span class="at">p_adjust =</span> <span class="fu">round</span>(p_adjust, <span class="dv">4</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">gene</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n_total</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n_stage_i</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n_stage_ii</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n_stage_iii</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n_stage_iV</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">statistic</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_adjust</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">pgr</td>
<td style="text-align: right;">1018</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">579</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">14.50</td>
<td style="text-align: right;">0.0023</td>
<td style="text-align: right;">0.0138</td>
</tr>
<tr class="even">
<td style="text-align: left;">tp53</td>
<td style="text-align: right;">1018</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">579</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">5.22</td>
<td style="text-align: right;">0.1566</td>
<td style="text-align: right;">0.4697</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brca1</td>
<td style="text-align: right;">1018</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">579</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">3.76</td>
<td style="text-align: right;">0.2881</td>
<td style="text-align: right;">0.5649</td>
</tr>
<tr class="even">
<td style="text-align: left;">esr1</td>
<td style="text-align: right;">1018</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">579</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">2.80</td>
<td style="text-align: right;">0.4235</td>
<td style="text-align: right;">0.5649</td>
</tr>
<tr class="odd">
<td style="text-align: left;">myc</td>
<td style="text-align: right;">1018</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">579</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">2.53</td>
<td style="text-align: right;">0.4707</td>
<td style="text-align: right;">0.5649</td>
</tr>
<tr class="even">
<td style="text-align: left;">erbb2</td>
<td style="text-align: right;">1018</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">579</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">1.96</td>
<td style="text-align: right;">0.5801</td>
<td style="text-align: right;">0.5801</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>It looks like there is indeed a significant non-random relationship between stage and the level of pgr expression. To determine exactly what this relationship is, we’ll follow up the KWT with a Dunn’s test (from the fsa package). The Dunn’s test is also a rank-based non-parametric test and will perform pairwise comparisons of expression values between different tumor stage groups. Note that the reason that we use the Dunn’s test as a follow up test to the KWT rather than just starting with it is because of the increased and unnecessary multiple testing burden that would be incurred if we did the Dunn’s test for each gene.</p>
<p><br><strong>Run the Dunn’s test on the pgr expression levels across tumor stages</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get just the pgr expression data</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>pgr_df <span class="ot">&lt;-</span> <span class="fu">filter</span>(plot_df, gene <span class="sc">==</span> <span class="st">'pgr'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>dunn_result <span class="ot">&lt;-</span> <span class="fu">dunnTest</span>(expression <span class="sc">~</span> stage_clean, <span class="at">data =</span> pgr_df)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(dunn_result<span class="sc">$</span>res) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Comparison</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Z</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P.unadj</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P.adj</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">stage i - stage ii</td>
<td style="text-align: right;">3.3433260</td>
<td style="text-align: right;">0.0008278</td>
<td style="text-align: right;">0.0049668</td>
</tr>
<tr class="even">
<td style="text-align: left;">stage i - stage iii</td>
<td style="text-align: right;">1.2775715</td>
<td style="text-align: right;">0.2014006</td>
<td style="text-align: right;">0.4028011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stage ii - stage iii</td>
<td style="text-align: right;">-2.0961327</td>
<td style="text-align: right;">0.0360704</td>
<td style="text-align: right;">0.1803521</td>
</tr>
<tr class="even">
<td style="text-align: left;">stage i - stage iv</td>
<td style="text-align: right;">2.0959216</td>
<td style="text-align: right;">0.0360891</td>
<td style="text-align: right;">0.1443566</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stage ii - stage iv</td>
<td style="text-align: right;">0.9113717</td>
<td style="text-align: right;">0.3620995</td>
<td style="text-align: right;">0.3620995</td>
</tr>
<tr class="even">
<td style="text-align: left;">stage iii - stage iv</td>
<td style="text-align: right;">1.5812821</td>
<td style="text-align: right;">0.1138135</td>
<td style="text-align: right;">0.3414406</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>So there is only one significant difference in pgr expression level between stages: In stage i the expression levels is significantly higher than in stage ii. The comparisons of stage i to other stages is nominally significant but not after multiple testing correction.</p>
<p>This suggests to us that pgr may be an important gene in a model that predicts whether a tumor is aggressive or not. Let’s end our exploratory analysis here and move into more rigorous modeling of the relationship between gene expression levels and disease status and outcomes. To make things simple as we get started using GLMs, we’ll first fit a very simple model that attempts to predict whether a tumor is aggressive or not based solely on pgr expression level.</p>
</section>
<section id="analysis-part-4-does-pgr-expression-level-predict-tumor-aggression" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-4-does-pgr-expression-level-predict-tumor-aggression"><br>Analysis part 4: Does pgr expression level predict tumor aggression?</h3>
<p>Let’s start with a very basic question. How well can we predict whether a tumor is aggressive or not given solely the expression level of pgr? To ask this, we’ll build a GLM using a binomial outcome distribution (appropriate for binary outcomes) and the logit link (the standard for binary outcomes). We’ll include pgr expression level and age as predictor variables. Our model will look like this:</p>
<p><span class="math display">\[\ln\left(\frac{\pi_i}{1-\pi_i}\right) = \beta_0 + \beta_1(\text{pgr_expr}_i) + \beta_2(\text{age}_i)\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\ln\left(\frac{\pi_i}{1-\pi_i}\right)\)</span>= log odds (or logit) link function that converts a probability into a continuous variable</li>
<li><span class="math inline">\(\pi_i\)</span> = probability of an aggressive tumor</li>
<li><span class="math inline">\(i\)</span> = an individual patient</li>
</ul>
<p>You can see from the equation that the linear predictor will produce a continues variable that is then used to fit a probability value to <span class="math inline">\(\pi_i\)</span> .</p>
<p>Note that the linear predictor is often denoted as <span class="math inline">\(\eta_i\)</span> and the logit link as: <span class="math display">\[\text{logit}(\pi_i)\]</span></p>
<p>As was true for OLM modeling, the probability prediction is just a mean prediction: it does not tell us anything about the expected variance around this mean. In the case of OLMs, the variance is assumed to be normally distributed and constant across all model predictions. This is not true with a logit link GLM. In this case, the variance depends on the value of the predicted probability. Let’s explain:</p>
<p>The variance structure follows a special case of the binomial distribution, where number of trials = 1. This special case of the binomial has a specific name: the Bernoulli distribution. In the Bernoulli, values are either 0 or 1, since each value is a binary outcome resulting from one trial. The mean of this distribution is equal to the probability of success in a given trial (<span class="math inline">\(p\)</span>), and the variance is <span class="math inline">\(p(1 - p)\)</span>. Let’s see how the variance changes for different values of <span class="math inline">\(p\)</span>:</p>
<ul>
<li><span class="math inline">\(p = 0.1\)</span>, variance <span class="math inline">\(= 0.1 \times (1 - 0.1) = 0.09\)</span></li>
<li><span class="math inline">\(p = 0.5\)</span>, variance <span class="math inline">\(= 0.5 \times (1 - 0.5) = 0.25\)</span></li>
<li><span class="math inline">\(p = 0.99\)</span>, variance <span class="math inline">\(= 0.99 \times (1 - 0.99) = 0.0099\)</span></li>
</ul>
<p>We see here that the variance is largest at intermediate probabilities. The same is true for probability prediction from our GLM: A probability prediction of 0.999 is going to have a much more narrow 95% CI than a probability prediction of 0.5.</p>
<p>Okay, let’s move on to making an actual model. First we will model the probability of an aggressive tumor given pgr expression level and the age of the patient.</p>
<p><br><strong>Create first model using pgr expression and age as predictors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fir the model</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>model_pgr <span class="ot">&lt;-</span> <span class="fu">glm</span>(aggressive_disease <span class="sc">~</span> pgr_expr <span class="sc">+</span> age, <span class="at">data=</span>analysis_data, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span> <span class="st">"logit"</span>))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the coefficients are in logit transformed scale. We will exponentiate them to put them on an odds-ratio scale. </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>tidy_model_pgr <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_pgr, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(., <span class="dv">5</span>)))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(tidy_model_pgr) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">'striped'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">statistic</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">13.70234</td>
<td style="text-align: right;">0.36923</td>
<td style="text-align: right;">7.08918</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">6.70629</td>
<td style="text-align: right;">28.54942</td>
</tr>
<tr class="even">
<td style="text-align: left;">pgr_expr</td>
<td style="text-align: right;">0.79052</td>
<td style="text-align: right;">0.02129</td>
<td style="text-align: right;">-11.04158</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">0.75773</td>
<td style="text-align: right;">0.82372</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.98595</td>
<td style="text-align: right;">0.00517</td>
<td style="text-align: right;">-2.73623</td>
<td style="text-align: right;">0.00621</td>
<td style="text-align: right;">0.97595</td>
<td style="text-align: right;">0.99595</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Note that the raw coefficient values returned by the model are logit-transformed. To make them easier to interpret, we exponentiated them when we extracted the model data with tidy(). We’ll discuss this below.</p>
<p>These results reveal that both age and pgr expression level are significant predictors of aggressive disease, as the p-values for these terms are very low. The pgr expression coefficient also has a value of .79 and the age coefficient a value of .98. How should we interpret these?</p>
<p><strong>Interpreting the pgr expression coefficient (0.79):</strong> An odds ratio of 0.79 means that for every 1-unit increase in log2 pgr expression, the odds of having an aggressive tumor are multiplied by 0.79. In other words, higher pgr expression is associated with lower odds of aggressive disease. Since 0.79 is less than 1, we can calculate that each unit increase in pgr expression reduces the odds of aggressive disease by approximately 21% (1 - 0.79 = 0.21).</p>
<p><strong>Interpreting the age coefficient (0.98):</strong> Similarly, for every 1-year increase in age, the odds of aggressive disease are multiplied by 0.98. This means that older patients have slightly lower odds of aggressive disease, with each additional year of age reducing the odds by approximately 2% (1 - 0.98 = 0.02).</p>
<p>Do these results make biological sense? They do! The negative association between pgr expression and aggressive disease aligns with our understanding of hormone receptor biology. The pgr gene encodes the progesterone receptor, and tumors with higher progesterone receptor expression are typically more responsive to hormone therapy and have better prognoses. The age effect suggests that aggressive disease might be more common in younger patients, which is consistent with some clinical observations.</p>
<p>Finally,remember that these coefficient values have multiplicative effects on the odds, not additive effects on the probability. A patient with both high pgr expression and older age would have their baseline odds multiplied by both factors: odds_new = odds_baseline × 0.79^(pgr_increase) × 0.98^(age_increase).</p>
<p>Let’s visualize the relationship between pgr expression level an probability of an aggressive tumor to help solidify our understanding. We’re going to hold age constant (at it’s mean value), and calculate the probability of an aggressive tumor or a range of pgr expression levels.</p>
<p><br><strong>Plot the relationship between pgr expression level and model-predicted probability</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a simulated df with a range of pgr expression levels pair3d with mean patient age</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="at">pgr_expr =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(analysis_data<span class="sc">$</span>pgr_expr, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">to =</span> <span class="fu">max</span>(analysis_data<span class="sc">$</span>pgr_expr, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="at">age =</span> <span class="fu">rep</span>(<span class="fu">mean</span>(analysis_data<span class="sc">$</span>age), <span class="dv">100</span>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># response transforms the predictions to the probability scale, rather than log-odds (link scale)</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>sim_data<span class="sc">$</span>pred_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_pgr, <span class="at">newdata =</span> sim_data, <span class="at">type=</span><span class="st">"response"</span>) </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the results</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x =</span> pgr_expr, <span class="at">y=</span>pred_probs)) <span class="sc">+</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color=</span><span class="st">"#F8766D"</span>) <span class="sc">+</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">'predicted probability'</span>, <span class="at">x =</span> <span class="st">'log2 pgr expression'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that there is a logistic relationship between expression level and probability, and that at intermediate expression levels, the affect of changing the expression level has the greatest effect on the predicted probability. This informs on why predicted probabilities in the middle range have higher variance: they are more sensitive to small differences in the output of the linear predictor within this range!</p>
<p>Okay, so we have a basic understanding of how this very simple GLM works. Now let’s assess how well it fits our training data. If this were an OLM, we would assess this with an R² value, which is calculated as an average of the residuals (the distance between a data point and the model fit). This calculation makes sense for an OLM where there residuals are assumed to follow a normal distribution and be constant across all predicted values. This is not true for GLMs, and thus calculating R² doesn’t really make sense. While there are some pseudo R² alternatives that can be calculated, a better and more common metric is to determine the <strong>Receiver Operating Characteristic (ROC)</strong> curve and calculate <strong>Area Under the Curve (AUC)</strong>. This provides a metric describing how much better the model fits the data compare to a null model. The ROC curve plots the true positive rate (sensitivity) against the false positive rate (1 - specificity) at various probability thresholds and helps visualize model fit.</p>
<p>The (AUC) is a single value that summarizes the overall performance of the model.</p>
<ul>
<li><p>AUC = 1: Perfect model, distinguishes between all positive and negative cases.</p></li>
<li><p>AUC = 0.5: Useless model, no better than random chance.</p></li>
<li><p>AUC &gt; 0.7: Intermediate fit. Whether this is adequate or not depends on your priorities.</p></li>
</ul>
<p>Let’s plot the ROC curve and calculate the AUC for our single gene model. To do this, we’ll need to get the tumor status predicted from our the model for each patient, then compare these to the actual tumor status. We’ll use roc from the pROC library to do this.</p>
<p><br><strong>Make ROC plot</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict probabilites of aggressive tumor from the analysis_data</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pred_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_pgr, <span class="at">newdata =</span> analysis_data, <span class="at">type =</span> <span class="st">"response"</span>) </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># compare the predicted binary outcomes and the actual binary outcomues</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>roc_obj_pgr <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="at">response =</span> analysis_data<span class="sc">$</span>aggressive_disease, <span class="at">predictor =</span> pred_probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting direction: controls &lt; cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put results in a df for plotting</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>roc_df_pgr <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">model =</span> <span class="st">'pgr + age'</span>, <span class="at">specificity =</span> <span class="fu">rev</span>(roc_obj_pgr<span class="sc">$</span>specificities), <span class="at">tpr =</span> <span class="fu">rev</span>(roc_obj_pgr<span class="sc">$</span>sensitivities))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot TPR vs FPR</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(roc_df_pgr, <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity, <span class="at">y =</span> tpr)) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#00B0F6"</span>, <span class="at">linewidth=</span><span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"False Positive Rate (1 - Specificity)"</span>, <span class="at">y =</span> <span class="st">"True Positive Rate (Sensitivity)"</span>) <span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>.<span class="dv">2</span>, <span class="at">y=</span>.<span class="dv">9</span>, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"AUC = "</span>, <span class="fu">round</span>(<span class="fu">auc</span>(roc_obj_pgr), <span class="dv">3</span>)), <span class="at">size=</span><span class="dv">6</span>)<span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ROC curve shows that our model is much better than a null model! However, it’s not great. At an approximate sensitivity of .5 (correctly identifying half of the tumors as aggressive, it will call ~20% of the non-aggressive tumors as aggressive). We can do better. Let’s move into the next section of our analysis where we fit a more complex model.</p>
</section>
<section id="analysis-part-5-does-a-model-that-incorporates-all-6-key-genes-predict-tumor-status-better" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-5-does-a-model-that-incorporates-all-6-key-genes-predict-tumor-status-better"><br> Analysis part 5: Does a model that incorporates all 6 key genes predict tumor status better?</h3>
<p>Let’s now build a more comprehensive model that predicts tumor aggresssion from age and the expression of all six genes of interest.</p>
<p><br><strong>Build a model that uses all 6 key genes and age as a predictors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fir the model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>model_6_genes <span class="ot">&lt;-</span> <span class="fu">glm</span>(aggressive_disease <span class="sc">~</span> age <span class="sc">+</span> erbb2_expr <span class="sc">+</span> tp53_expr <span class="sc">+</span> brca1_expr <span class="sc">+</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                       myc_expr <span class="sc">+</span> esr1_expr <span class="sc">+</span> pgr_expr, <span class="at">data =</span> analysis_data, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span> <span class="st">"logit"</span>))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the coefficients</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>tidy_model_6_genes <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_6_genes, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(., <span class="dv">5</span>)))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(tidy_model_6_genes) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">'striped'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">statistic</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">132.81629</td>
<td style="text-align: right;">1.55099</td>
<td style="text-align: right;">3.15215</td>
<td style="text-align: right;">0.00162</td>
<td style="text-align: right;">6.50082</td>
<td style="text-align: right;">2862.74289</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">1.00284</td>
<td style="text-align: right;">0.00568</td>
<td style="text-align: right;">0.49976</td>
<td style="text-align: right;">0.61724</td>
<td style="text-align: right;">0.99174</td>
<td style="text-align: right;">1.01410</td>
</tr>
<tr class="odd">
<td style="text-align: left;">erbb2_expr</td>
<td style="text-align: right;">0.96215</td>
<td style="text-align: right;">0.05058</td>
<td style="text-align: right;">-0.76287</td>
<td style="text-align: right;">0.44554</td>
<td style="text-align: right;">0.87121</td>
<td style="text-align: right;">1.06256</td>
</tr>
<tr class="even">
<td style="text-align: left;">tp53_expr</td>
<td style="text-align: right;">0.93279</td>
<td style="text-align: right;">0.09196</td>
<td style="text-align: right;">-0.75656</td>
<td style="text-align: right;">0.44931</td>
<td style="text-align: right;">0.77879</td>
<td style="text-align: right;">1.11741</td>
</tr>
<tr class="odd">
<td style="text-align: left;">brca1_expr</td>
<td style="text-align: right;">1.03664</td>
<td style="text-align: right;">0.07272</td>
<td style="text-align: right;">0.49488</td>
<td style="text-align: right;">0.62068</td>
<td style="text-align: right;">0.89870</td>
<td style="text-align: right;">1.19554</td>
</tr>
<tr class="even">
<td style="text-align: left;">myc_expr</td>
<td style="text-align: right;">1.00714</td>
<td style="text-align: right;">0.06177</td>
<td style="text-align: right;">0.11523</td>
<td style="text-align: right;">0.90826</td>
<td style="text-align: right;">0.89230</td>
<td style="text-align: right;">1.13702</td>
</tr>
<tr class="odd">
<td style="text-align: left;">esr1_expr</td>
<td style="text-align: right;">0.70466</td>
<td style="text-align: right;">0.03787</td>
<td style="text-align: right;">-9.24294</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">0.65300</td>
<td style="text-align: right;">0.75764</td>
</tr>
<tr class="even">
<td style="text-align: left;">pgr_expr</td>
<td style="text-align: right;">0.95404</td>
<td style="text-align: right;">0.02905</td>
<td style="text-align: right;">-1.61941</td>
<td style="text-align: right;">0.10536</td>
<td style="text-align: right;">0.90131</td>
<td style="text-align: right;">1.01016</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The results from our six-gene model reveal some interesting changes compared to the pgr-only model. Most notably, only esr1 expression emerges as a significant predictor: (p &lt; 0.001, odds ratio = 0.70). This means that for every 1-unit increase in log2 esr1 expression, the odds of aggressive disease decrease by 30%.</p>
<p><strong>What happened to our previous significant predictors?</strong></p>
<p>Both pgr expression and age, which were significant in the simpler model, are no longer statistically significant. This shift illustrates a key principle in multivariate modeling: when variables are correlated, it becomes statistically difficult to detect their individual contributions. The model may assign most explanatory power to one predictor even when multiple predictors have genuine independent effects.</p>
<p>In the single-gene model, pgr appeared significant because it was capturing the broader hormone receptor biology associated with tumor aggression. However, when esr1 was added to the model, it emerged as the stronger predictor of this same underlying biology. This doesn’t mean pgr is unimportant for tumor aggression - rather, esr1 better represents the hormone-responsive phenotype that both genes contribute to. Since pgr and esr1 are correlated, the model assigns most of the explanatory power to the stronger predictor (esr1), making pgr appear non-significant in this context.</p>
<p>This situation highlights an important distinction between explanation and prediction. When dealing with correlated predictors, individual coefficient values may not accurately reflect true causal relationships - the model may arbitrarily “choose” one correlated predictor over another. However, the model’s predictive power doesn’t depend on perfectly identifying causal relationships. If our primary goal is predicting tumor aggressiveness in new patients, a model with imperfect coefficient interpretations can still perform well, provided we validate its predictive accuracy through proper testing methods like cross-validation (see below).</p>
<p>None of the other cancer genes (erbb2, tp53, brca1, myc) reached statistical significance in this model. This doesn’t necessarily mean these genes are unimportant for cancer biology, but rather that their effects on aggressive disease may be more complex or require different modeling approaches (such as interaction terms or non-linear transformations).</p>
<p><strong>Should we keep these non-significant genes in the model for future predictions?</strong></p>
<p>This question highlights a fundamental challenge in high-dimensional genomics data: we have many potentially important variables but limited statistical power to detect their individual effects. This creates a tradeoff:</p>
<p><strong>The dilemma:</strong></p>
<ul>
<li><strong>Keep all genes</strong>: Biologically comprehensive but risks overfitting and reduces statistical power by reduced degrees of freedom. Variance and coefficient instability will also increase when predictors are collinear.</li>
<li><strong>Remove non-significant genes</strong>: Statistically cleaner but may discard important biological information and could miss complex interactions.</li>
</ul>
<p>In the next analysis sections, we will deal with these challenges using a technique called regularization that will help to determine which predictor variables to keep so as to maximize predictive power without adding unnecessary complexity or overfitting risk. For now however, let’s move on towards assessing whether this model fits the training data better than the single gene pgr model. Just out of curiosity, we’ll also test how a model that only includes ers1 expression compares as well.</p>
<p><br><strong>Make ROC plots for the new model and compare to the single gene model</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ROC curves and plot data for the 6-gene model</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>pred_probs_6_genes <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_6_genes, <span class="at">newdata =</span> analysis_data, <span class="at">type =</span> <span class="st">"response"</span>) </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>roc_obj_6_genes <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="at">response =</span> analysis_data<span class="sc">$</span>aggressive_disease, </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">predictor =</span> pred_probs_6_genes)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>roc_df_6_genes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">model =</span> <span class="st">'6_genes + age'</span>, </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">specificity =</span> <span class="fu">rev</span>(roc_obj_6_genes<span class="sc">$</span>specificities), </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">tpr =</span> <span class="fu">rev</span>(roc_obj_6_genes<span class="sc">$</span>sensitivities))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="do">## create the esr1 only model and calculate ROC and plot data</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>model_esr1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(aggressive_disease <span class="sc">~</span> esr1_expr, <span class="at">data =</span> analysis_data, </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span> <span class="st">"logit"</span>))</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>pred_probs_esr1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_esr1, <span class="at">newdata =</span> analysis_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>roc_obj_esr1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="at">response =</span> analysis_data<span class="sc">$</span>aggressive_disease, </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">predictor =</span> pred_probs_esr1)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>roc_df_esr1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">model =</span> <span class="st">'esr1'</span>, <span class="at">specificity =</span> <span class="fu">rev</span>(roc_obj_esr1<span class="sc">$</span>specificities), </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tpr =</span> <span class="fu">rev</span>(roc_obj_esr1<span class="sc">$</span>sensitivities))</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the 3 ROC dataframes by row to make a tidy table</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>combined_roc_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(roc_df_pgr, roc_df_6_genes, roc_df_esr1)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all three ROC curves</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_roc_df, <span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">-</span>specificity, <span class="at">y=</span>tpr, <span class="at">color=</span>model)) <span class="sc">+</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"False Positive Rate (1 - Specificity)"</span>, <span class="at">y =</span> <span class="st">"True Positive Rate (Sensitivity)"</span>) <span class="sc">+</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"6_genes + age"</span> <span class="ot">=</span> <span class="fu">hue_pal</span>()(<span class="dv">3</span>)[<span class="dv">1</span>], <span class="st">"esr1"</span> <span class="ot">=</span> <span class="fu">hue_pal</span>()(<span class="dv">3</span>)[<span class="dv">2</span>], <span class="st">"pgr + age"</span> <span class="ot">=</span> <span class="fu">hue_pal</span>()(<span class="dv">3</span>)[<span class="dv">3</span>]),</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"6-gene model (AUC ="</span>, <span class="fu">round</span>(<span class="fu">auc</span>(roc_obj_6_genes), <span class="dv">3</span>), <span class="st">")"</span>), </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">paste</span>(<span class="st">"esr1 model (AUC ="</span>, <span class="fu">round</span>(<span class="fu">auc</span>(roc_obj_esr1), <span class="dv">3</span>), <span class="st">")"</span>),</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">paste</span>(<span class="st">"pgr model (AUC ="</span>, <span class="fu">round</span>(<span class="fu">auc</span>(roc_obj_pgr), <span class="dv">3</span>), <span class="st">")"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The 6-gene model clearly fits the data better than the pgr-only model. The esr1 curve is essentially the same as the 6-gene model, indicating that nearly all of the predictive power of the 6-gene model is due to the inclusing of esr1. Apparantly, at least in the context of the training dataset, the other genes and the age parameter do not add any predictive power beyond esr1 expression.</p>
<p>Okay, time to move on to even more complex models, and to incorporate regularization.</p>
</section>
<section id="analysis-part-6-does-a-model-that-incorporates-100-genes-fit-the-data-better" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-6-does-a-model-that-incorporates-100-genes-fit-the-data-better"><br>Analysis part 6: Does a model that incorporates 100+ genes fit the data better?</h3>
<p>Let’s now try to fit a model that uses more genes to see if adding more genes beyond just esr1 provides more predictive power. We’ll start by assuming that the most informative genes in the dataset will be the ones that vary most across patients. So we’ll start by extracting the top 100 genes with the most variance.</p>
<p><br><strong>Get the top 100 most variables genes from the expression_data df</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the variance for each gene </span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># apply usage: apply(df to act on, 1=rowise, 2=columnwise, function to apply, remove missing data before calculation)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>expression_variance <span class="ot">&lt;-</span> <span class="fu">apply</span>(expression_data, <span class="dv">1</span>, var, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="co"># creates names numeric vector</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>top_100_variance_gene_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">sort</span>(expression_variance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>))[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>expr_data_top_100_var <span class="ot">&lt;-</span> <span class="fu">t</span>(expression_data[top_100_variance_gene_names,]) <span class="co"># transpose so that rows are patient ids, same as in analysis_data</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>expr_data_top_100_var <span class="ot">&lt;-</span> expr_data_top_100_var[<span class="fu">rownames</span>(analysis_data),] <span class="co"># keep only the patients that passed all filtering and are in analysis_data</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the order of patient ids is the same in analysis_data and expr_data_top_100_var</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">identical</span>(<span class="fu">rownames</span>(expr_data_top_100_var), <span class="fu">rownames</span>(analysis_data))) {</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Row names of the expr_data_top_100_var and analysis_data datframes are identical"</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Row names of the expr_data_top_100_var and analysis_data datframes are identical</code></pre>
</div>
</div>
<p><br><strong>Create a df with metadata and expression data for the top 100 variable genes</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the relevant columns from analysis_data with the top 100 expression values</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>analysis_data_100_genes <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">select</span>(analysis_data, <span class="sc">!</span><span class="fu">matches</span>(<span class="st">"_expr|_high|_low"</span>)), expr_data_top_100_var)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"analysis_data_100_genes is a"</span>, <span class="fu">nrow</span>(analysis_data_100_genes), <span class="st">"by"</span>, <span class="fu">ncol</span>(analysis_data_100_genes), <span class="fu">class</span>(expr_data_top_100_var), <span class="st">"with patient ids as rows and metadata and log2 gene expression values as columns"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>analysis_data_100_genes is a 1040 by 112 matrix array with patient ids as rows and metadata and log2 gene expression values as columns</code></pre>
</div>
</div>
<p>Let’s now test whether there is non-nan expression data for all of these genes. Since the GLM only can compute on patients that have non-nan values for all predictor variables, we want to know how many patients this is true for.</p>
<p><br><strong>Print how many patients have expression data for all 100 genes, age, and tumor status</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>complete <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(analysis_data_100_genes[,<span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"aggressive_disease"</span>, top_100_variance_gene_names)])</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"There are"</span>,<span class="fu">sum</span>(complete), <span class="st">"patients with non-nan data for all predictor variables, and"</span>, <span class="fu">sum</span>(<span class="sc">!</span>complete), <span class="st">"patients with missing data in one or more variables"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 0 patients with non-nan data for all predictor variables, and 1040 patients with missing data in one or more variables</code></pre>
</div>
</div>
<p>0 patients with complete data! This is going to be a problem. How to deal with this? We have a few options:</p>
<ol type="1">
<li>Remove genes that have missing data for &gt;X% of patients and see if this gets us to a reasonable number of patients with non-missing data.</li>
<li>Impute the missing expression values as the median of the existing values (this is crude and underestimates variance) or use more complex techniques that consider co-variances between expression levels.</li>
</ol>
<p>For this tutorial, we will do #1, but in order to end up with 100+ genes to include in our model, we’ll start by selecting a larger group of genes (1000 instead of 100), then subsetting these to only include the genes that have expression data for &gt;95% of patients.</p>
<p><br><strong>Get 1000 most variable genes and subset for those that have data for &gt;95% of patients</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>top_1000_variance_gene_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">sort</span>(expression_variance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>))[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># transpose so that rows are patient ids, same as in analysis_data</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>expr_data_top_1000_var <span class="ot">&lt;-</span> <span class="fu">t</span>(expression_data[top_1000_variance_gene_names,]) </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only the patients that passed all filtering and are in analysis_data</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>expr_data_top_1000_var <span class="ot">&lt;-</span> expr_data_top_1000_var[<span class="fu">rownames</span>(analysis_data),] </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># apply function col-wise</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>propr_missing <span class="ot">&lt;-</span> <span class="fu">apply</span>(expr_data_top_1000_var, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x))<span class="sc">/</span><span class="fu">length</span>(x)) </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"There are"</span>, <span class="fu">sum</span>(propr_missing <span class="sc">&lt;</span>.<span class="dv">005</span>), <span class="st">"genes with missing data for less than .05% of patients"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 158 genes with missing data for less than .05% of patients</code></pre>
</div>
</div>
<p>158 genes is a much better number to work with. Let’s merge these genes with the analysis df and see how many patients there are with complete data for all predictors</p>
<p><br><strong>Select the 158 genes and merge with the analysis_df</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the names of the 158 genes</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>keepr_gene_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(expr_data_top_1000_var[,propr_missing <span class="sc">&lt;</span> .<span class="dv">005</span>])</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the 158 genes with the analysis data</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>analysis_data_158_genes <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">select</span>(analysis_data, <span class="sc">!</span><span class="fu">matches</span>(<span class="st">"_expr|_high|_low"</span>)), expr_data_top_1000_var[,keepr_gene_names])</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># usr complete.cases() to subset to only patients with no missing data</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>complete <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(analysis_data_158_genes[,<span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"aggressive_disease"</span>, keepr_gene_names)])</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"There are"</span>,<span class="fu">sum</span>(complete), <span class="st">"patients with non-NaN data for all predictor variables, and"</span>, <span class="fu">sum</span>(<span class="sc">!</span>complete), <span class="st">"patients with missing data in one or more variables"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 900 patients with non-NaN data for all predictor variables, and 140 patients with missing data in one or more variables</code></pre>
</div>
</div>
<p>900 is certainly better than 0! Let’s proceed to fitting the model.</p>
<p><br><strong>Fit model with 158 genes and age as predictors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the predictor string</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>formula_string <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"aggressive_disease ~ age +"</span>, <span class="fu">paste</span>(keepr_gene_names, <span class="at">collapse=</span><span class="st">' + '</span>))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the GLM</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>model_158_genes <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">as.formula</span>(formula_string), <span class="at">data =</span> analysis_data_158_genes, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>tidy_model_158_genes <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_158_genes, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(., <span class="dv">5</span>))) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(p.value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we have 159 predictors, let’s do a multiple testing correction on the coefficient p-values.</p>
<p><br><strong>Do multiple testing correction and display model stats for top predictors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add an adjusted p-value column</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>tidy_model_158_genes <span class="ot">&lt;-</span> tidy_model_158_genes <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">p.adjusted =</span> <span class="fu">p.adjust</span>(p.value, <span class="at">method =</span> <span class="st">"BH"</span>))</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># display the top 10 rows in the table</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(tidy_model_158_genes[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">'striped'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">statistic</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">conf.high</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p.adjusted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ESR1</td>
<td style="text-align: right;">0.65805</td>
<td style="text-align: right;">0.10815</td>
<td style="text-align: right;">-3.86938</td>
<td style="text-align: right;">0.00011</td>
<td style="text-align: right;">0.53023</td>
<td style="text-align: right;">8.108600e-01</td>
<td style="text-align: right;">0.0176000</td>
</tr>
<tr class="even">
<td style="text-align: left;">PKP1</td>
<td style="text-align: right;">0.78389</td>
<td style="text-align: right;">0.07725</td>
<td style="text-align: right;">-3.15201</td>
<td style="text-align: right;">0.00162</td>
<td style="text-align: right;">0.67217</td>
<td style="text-align: right;">9.104400e-01</td>
<td style="text-align: right;">0.1104000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CLIC6</td>
<td style="text-align: right;">0.85203</td>
<td style="text-align: right;">0.05199</td>
<td style="text-align: right;">-3.07990</td>
<td style="text-align: right;">0.00207</td>
<td style="text-align: right;">0.76866</td>
<td style="text-align: right;">9.427900e-01</td>
<td style="text-align: right;">0.1104000</td>
</tr>
<tr class="even">
<td style="text-align: left;">TF</td>
<td style="text-align: right;">0.79993</td>
<td style="text-align: right;">0.07526</td>
<td style="text-align: right;">-2.96633</td>
<td style="text-align: right;">0.00301</td>
<td style="text-align: right;">0.68774</td>
<td style="text-align: right;">9.242400e-01</td>
<td style="text-align: right;">0.1204000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SLC27A2</td>
<td style="text-align: right;">0.82423</td>
<td style="text-align: right;">0.06733</td>
<td style="text-align: right;">-2.87098</td>
<td style="text-align: right;">0.00409</td>
<td style="text-align: right;">0.72098</td>
<td style="text-align: right;">9.393100e-01</td>
<td style="text-align: right;">0.1216000</td>
</tr>
<tr class="even">
<td style="text-align: left;">NELL2</td>
<td style="text-align: right;">1.18577</td>
<td style="text-align: right;">0.06051</td>
<td style="text-align: right;">2.81613</td>
<td style="text-align: right;">0.00486</td>
<td style="text-align: right;">1.05414</td>
<td style="text-align: right;">1.336890e+00</td>
<td style="text-align: right;">0.1216000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ADAMTS16</td>
<td style="text-align: right;">0.80125</td>
<td style="text-align: right;">0.07950</td>
<td style="text-align: right;">-2.78711</td>
<td style="text-align: right;">0.00532</td>
<td style="text-align: right;">0.68448</td>
<td style="text-align: right;">9.353300e-01</td>
<td style="text-align: right;">0.1216000</td>
</tr>
<tr class="even">
<td style="text-align: left;">FMO2</td>
<td style="text-align: right;">1.33410</td>
<td style="text-align: right;">0.10664</td>
<td style="text-align: right;">2.70319</td>
<td style="text-align: right;">0.00687</td>
<td style="text-align: right;">1.08609</td>
<td style="text-align: right;">1.651250e+00</td>
<td style="text-align: right;">0.1228444</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WFDC2</td>
<td style="text-align: right;">0.85431</td>
<td style="text-align: right;">0.05830</td>
<td style="text-align: right;">-2.70102</td>
<td style="text-align: right;">0.00691</td>
<td style="text-align: right;">0.76125</td>
<td style="text-align: right;">9.571400e-01</td>
<td style="text-align: right;">0.1228444</td>
</tr>
<tr class="even">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">3774.67594</td>
<td style="text-align: right;">3.22956</td>
<td style="text-align: right;">2.55021</td>
<td style="text-align: right;">0.01077</td>
<td style="text-align: right;">7.16268</td>
<td style="text-align: right;">2.329064e+06</td>
<td style="text-align: right;">0.1620364</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>There are&gt;9 genes with nominally significant p-values, but only esr1 is significant after BH multiple testing correction. We’ll talk about ways to better assess and improve this model in a minute, but first let’s just compare how well this model fits the training data to how well the esr1 only model fits the training data.</p>
<p><br><strong>Plot ROC curvves for the 158 gene model and the esr1 only model</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict tumor status using the 158 gene model and make a plot df</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pred_probs_158_genes <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_158_genes, <span class="at">newdata =</span> analysis_data_158_genes, </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">type =</span> <span class="st">"response"</span>) </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>roc_obj_158_genes <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="at">response =</span> analysis_data_158_genes<span class="sc">$</span>aggressive_disease, </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">predictor =</span> pred_probs_158_genes)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>roc_df_158_genes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">model =</span> <span class="st">'158 genes'</span>, </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">specificity =</span> <span class="fu">rev</span>(roc_obj_158_genes<span class="sc">$</span>specificities), </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tpr =</span> <span class="fu">rev</span>(roc_obj_158_genes<span class="sc">$</span>sensitivities))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(roc_df_158_genes, roc_df_esr1)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">-</span>specificity, <span class="at">y=</span>tpr, <span class="at">color=</span>model)) <span class="sc">+</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth=</span><span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">'FPR'</span>, <span class="at">y=</span><span class="st">'TPR'</span>) <span class="sc">+</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"158 genes"</span> <span class="ot">=</span> <span class="fu">hue_pal</span>()(<span class="dv">3</span>)[<span class="dv">1</span>], <span class="st">"esr1"</span> <span class="ot">=</span> <span class="fu">hue_pal</span>()(<span class="dv">3</span>)[<span class="dv">3</span>]), </span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"158 genes model (AUC ="</span>, <span class="fu">round</span>(<span class="fu">auc</span>(roc_obj_158_genes),<span class="dv">3</span>), <span class="st">")"</span>), </span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">paste</span>(<span class="st">"esr1 model (AUC ="</span>, <span class="fu">round</span>(<span class="fu">auc</span>(roc_obj_esr1), <span class="dv">3</span>), <span class="st">")"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The 158 gene model does fit the training data much better than the esr1 only model. This looks pretty good, but now we have to consider some of the concerns related to having a model with so many different predictors. Let’s describe these:</p>
<ol type="1">
<li><strong>Multicollinearity</strong> - With so many predictor variables, it is likely that some will be collinear, thus making the parameter values unstable (prone to large changes given small differences in training data), and likely inaccurate, as the model has a hard time determining which of a set of collinear parameters is actually predictive of the outcome (we already saw this above with pgr and esr1). This problem makes the model prone to overfitting, as the inaccurate parameter values will produce poor predictions on a new test dataset. This is also a problem for interpretation of the model, as the parameters values will likely be inaccurate, and will change dramatically if even small changes are made to the training data.</li>
<li><strong>Overly complex model with too many parameters</strong> - As a general rule of thumb, you want there to be &gt;10X as many samples as parameters to estimate, such that the model has sufficient degrees of freedom to avoid overfitting (the 158 gene model only has 900 patients, so this condition is not met). Even if this condition is met, it’s a good idea to consider removing unnecessary parameters, such as those that don’t significantly contribute to prediction. Unnecessary parameters can also result in overfitting.</li>
</ol>
<p>The potential negative consequence of multicollinearity, too-few degrees of freedom and/or an overly complex model are overfitting, and poor predictive performance on test datasets. How can we assess whether this is happening? Let’s use k-fold cross validation to train and test our model on distinct datasets. If the model performs significantly worse on the test datasets than it’s fit to the training dataset, this is a sign of overfitting.</p>
<p>To do k-fold cross validation, we’ll use the <strong>caret</strong> package. This is a powerful package that allows us to systematically evaluate model performance through automated cross-validation procedures and can be used to perform k-fold cross validation on a wide variety of different linear model and machine learning model types, from simple linear regression to complex ensemble methods. The caret package handles the complex logistics of splitting data, fitting models on training folds, making predictions on test folds, and aggregating performance metrics across all iterations.</p>
<p><strong>How k-fold cross validation works:</strong></p>
<ol type="1">
<li><p><strong>Split the data</strong>: Divide your dataset into k equal-sized “folds” (commonly k=5 or k=10)</p></li>
<li><p><strong>Iterative training and testing</strong>: For each fold:</p>
<ul>
<li><p>Use k-1 folds as training data to fit the model</p></li>
<li><p>Use the remaining fold as test data to evaluate performance</p></li>
<li><p>Record the performance metric (e.g., AUC)</p></li>
</ul></li>
<li><p><strong>Aggregate results</strong>: Calculate the mean and standard deviation of performance across all k iterations</p></li>
</ol>
<p><strong>How this reveals overfitting:</strong></p>
<ul>
<li><p><strong>Training performance</strong> reflects how well the model fits the data it was trained on</p></li>
<li><p><strong>Cross-validation performance</strong> reflects how well the model generalizes to new, unseen data</p></li>
<li><p>A large gap between these two indicates the model has memorized training-specific patterns rather than learning generalizable relationships</p></li>
</ul>
<p>In our 158-gene model, we’ll compare the training AUC (how well it fits the original data) to the cross-validation AUC (how well it predicts on held-out test sets). If we see a substantial drop in performance, this confirms our suspicion of overfitting due to the high-dimensional predictor space and multicollinearity issues we identified.</p>
<p><br> <strong>Run 5-fold cross validation</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up train / test algorithm </span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>train_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>, <span class="co"># define method is cross-validation</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> <span class="dv">5</span>, <span class="co"># k = 5 folds</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="co"># save probability predictions to calculate AUC</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">summaryFunction =</span> twoClassSummary, <span class="co"># Use summary for binary classification</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># train cannot handle any rows with missing data so I will need to remove them from the dataset</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>analysis_data_158_genes_clean <span class="ot">&lt;-</span> analysis_data_158_genes[<span class="fu">complete.cases</span>(analysis_data_158_genes[, <span class="fu">c</span>(<span class="st">"age"</span>, keepr_gene_names)]), ]</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># when modeling using a binomial, the outcome variables must be a factor with two levels</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>analysis_data_158_genes_clean<span class="sc">$</span>aggressive_disease <span class="ot">&lt;-</span> <span class="fu">factor</span>(analysis_data_158_genes_clean<span class="sc">$</span>aggressive_disease, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"non_aggressive"</span>, <span class="st">"aggressive"</span>))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the CV </span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a> model_158_gene_cv <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(formula_string),</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> analysis_data_158_genes_clean,</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glm"</span>,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="co"># For a logistic regression model</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> train_control,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"ROC"</span>) <span class="co"># specify how performance is assessed. There are many options here. ROC refers to the Area Under the ROC Curve (AUC). Another reasonable option for this dataset would be "logLoss", which compares the predicted probabilities to the true outcomes, and thus penalizes confident wrong predictions strongly.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br> <strong>Print the AUC values for model performance on the 5 test sets</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The AUC values for the 5 resamples are:</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">round</span>(model_158_gene_cv<span class="sc">$</span>resample<span class="sc">$</span>ROC,<span class="dv">3</span>), <span class="at">collapse=</span><span class="st">'</span><span class="sc">\n</span><span class="st">'</span>), </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">The mean is"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(model_158_gene_cv<span class="sc">$</span>resample<span class="sc">$</span>ROC),<span class="dv">3</span>), </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"and the SD is"</span>, <span class="fu">round</span>(<span class="fu">sd</span>(model_158_gene_cv<span class="sc">$</span>resample<span class="sc">$</span>ROC),<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The AUC values for the 5 resamples are:
 0.677
0.756
0.664
0.737
0.747 
The mean is 0.716 and the SD is 0.043</code></pre>
</div>
</div>
<p>Compared to our AUC for the training performance of 158 gene model (AUC=.881), these AUC values from cross-validation are substantially worse. This is a strong indication that our 158 gene model is overfit to the training data. As mentioned above, this is likely due to a combination of multicollinearity and too few patients for the 159 predictors. To explicitly assess collinearity, we’ll use the vif package.</p>
<p><br><strong>Run vif on the 158 gene model</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>vif_values <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">vif</span>(model_158_genes), <span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>vif_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">gene =</span> <span class="fu">names</span>(vif_values), <span class="at">vif_value =</span> vif_values)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(vif_df, <span class="at">row.names =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">'striped'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">gene</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">vif_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">PLIN1</td>
<td style="text-align: right;">33.32577</td>
</tr>
<tr class="even">
<td style="text-align: left;">GPD1</td>
<td style="text-align: right;">25.49730</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PLIN4</td>
<td style="text-align: right;">21.74640</td>
</tr>
<tr class="even">
<td style="text-align: left;">KCNIP2</td>
<td style="text-align: right;">21.36841</td>
</tr>
<tr class="odd">
<td style="text-align: left;">COL10A1</td>
<td style="text-align: right;">18.62743</td>
</tr>
<tr class="even">
<td style="text-align: left;">FABP4</td>
<td style="text-align: right;">17.90314</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SFRP1</td>
<td style="text-align: right;">17.05098</td>
</tr>
<tr class="even">
<td style="text-align: left;">COL17A1</td>
<td style="text-align: right;">16.21052</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IGJ</td>
<td style="text-align: right;">15.71163</td>
</tr>
<tr class="even">
<td style="text-align: left;">AKR1C1</td>
<td style="text-align: right;">15.42158</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>These are only the top 10 vif values, and all are much greater than 10, indicating very problematic multicollinearity. Clearly the 158 gene model has some serious issues that are causing overfitting. In the next section we’ll work through how to manage this.</p>
</section>
<section id="analysis-part-7-can-regularization-methods-improve-model-performance" class="level3">
<h3 class="anchored" data-anchor-id="analysis-part-7-can-regularization-methods-improve-model-performance"><br>Analysis part 7: Can regularization methods improve model performance?</h3>
<section id="the-high-dimensional-challenge-in-cancer-genomics" class="level4">
<h4 class="anchored" data-anchor-id="the-high-dimensional-challenge-in-cancer-genomics"><strong>The High-Dimensional Challenge in Cancer Genomics</strong></h4>
<p>Our 158-gene model demonstrates a classic problem in cancer genomics: we have far more predictors than we can reliably estimate with our sample size. The cross-validation results showed substantial overfitting (training AUC = 0.881 vs.&nbsp;CV AUC ≈ 0.75), and the VIF analysis revealed severe multicollinearity among our predictors. This situation is endemic in genomics research for the following reasons:</p>
<p><strong>Wide data:</strong> Thousands of genes but only hundreds of patients</p>
<p><strong>Correlated predictors:</strong> Genes in the same pathway often have similar expression patterns</p>
<p>Traditional approaches like stepwise regression or manual feature selection are inadequate for this scenario because they make hard “keep/remove” decisions that ignore the uncertainty in our parameter estimates and the interconnected nature of biological systems.</p>
</section>
<section id="regularization-a-principled-approach-to-model-complexity" class="level4">
<h4 class="anchored" data-anchor-id="regularization-a-principled-approach-to-model-complexity">Regularization: A Principled Approach to Model Complexity</h4>
<p>Regularization techniques address overfitting by adding a penalty term to the loss function that shrinks coefficient estimates toward zero. What is the loss function? The loss function is the function that the model seeks to minimize the result of during fitting. In non-regularized models, the loss function is described as:</p>
<p>Loss Function = Prediction Error</p>
<p>And so the best fitting model will be the one with the smallest prediction error. The downside of optimizing the model in this way is that is allows for the possibility that many predictors get assigned coefficients that make incremental reductions in the loss function but that result in a model that is overfit to the training data.</p>
<p>In regularization, model fitting still attempts to minimize the loss function, but the function looks different:</p>
<p>Loss Function = Prediction Error + λ × Penalty Term</p>
<p>The key here is the “Penalty Term”, which can be calculated in different ways, but is always proportional to the size of the parameter coefficients. The different ways in which the penalty term can be calculated define the different types of regularization:</p>
<p><strong>LASSO Regression (L1 Penalty)</strong></p>
<ul>
<li><p>Penalty: λ × Σ|βᵢ| (sum of absolute coefficients)</p></li>
<li><p>Effect: Due to the geometry of the penalty function, this shrinks many coefficients to exactly zero, thereby performing automatic variable selection</p></li>
<li><p>Best for: When only a sparse subset of variables are truly important, e.g.&nbsp;when the expectation is that key driver mutations or biomarkers may have dominant effects</p></li>
</ul>
<p><strong>Ridge Regression (L2 Penalty)</strong></p>
<ul>
<li><p>Penalty: λ × Σβ²ᵢ (sum of squared coefficients)</p></li>
<li><p>Effect: Due to the geometry of the penalty function, this shrinks all coefficients but keeps all variables in the model</p></li>
<li><p>Best for: When many variables contribute small effects, e.g.&nbsp;in cancer detection where dysregulation of entire pathways, rather than just individual genes, is common</p></li>
</ul>
<p><strong>Elastic Net (Combined L1 + L2)</strong></p>
<ul>
<li><p>Penalty: λ × (α × Σ|βᵢ| + (1-α) × Σβ²ᵢ)</p></li>
<li><p>Effect: Balances variable selection with handling correlated predictors</p></li>
<li><p>Best for: High-dimensional data with groups of correlated predictors, e.g.&nbsp;balancing pathway level effects with large effect predictors</p></li>
</ul>
</section>
<section id="how-might-our-final-model-look-different-across-these-three-methods" class="level4">
<h4 class="anchored" data-anchor-id="how-might-our-final-model-look-different-across-these-three-methods">How might our final model look different across these three methods?</h4>
<p>In general, we expect a regularized model to sacrifice some amount of goodness of fit to the training data, but to perform far better for prediction. More specifically, given our 158 gene model:</p>
<p>LASSO will:</p>
<ul>
<li><p>Pick representative genes from correlated groups, thereby “forcing” a choice among correlated predictors</p></li>
<li><p>Set the rest to exactly zero</p></li>
<li><p>Return a sparse, interpretable model</p></li>
<li><p>Note that there is instability in the process of picking genes from correlated groups, and that small changes in the training data may result in different genes being picked</p></li>
</ul>
<p>Ridge will:</p>
<ul>
<li><p>Give small coefficients to many of the 158 genes, thus handling correlated genes by shrinking them all proportionally</p></li>
<li><p>Keep all variables in the model, making interpretation difficult</p></li>
<li><p>Provide stable results but less biological insight about potentail key drivers</p></li>
</ul>
<p>Elastic Net will:</p>
<ul>
<li><p>Combines both approaches: tends to keep small groups of correlated predictors with shrunken coefficients</p></li>
<li><p>Partially addresses multicollinearity through selection, partially through shrinkage</p></li>
</ul>
</section>
<section id="okay-but-what-about-the-λ-in-the-loss-function" class="level4">
<h4 class="anchored" data-anchor-id="okay-but-what-about-the-λ-in-the-loss-function">Okay, but what about the λ in the loss function?</h4>
<p>λ is a regularization parameter that determines the strength of the regularization effect. It is effectively a dial that determines the trade-off between model accuracy and model simplicity (and its ability to generalize).</p>
<p>A λ value of .001 is considered a light penalty (higher accuracy), whereas a value of 10 is a high penalty (greater simplicity). A non-regularized model has a λ value of 0.</p>
<p><strong>How does λ get chosen?</strong></p>
<p>In practice, we don’t guess λ - we use cross-validation to find the optimal value:</p>
<ol type="1">
<li><p>Try many λ values (e.g., 0.001, 0.01, 0.1, 1, 10, 100)</p></li>
<li><p>For each λ, fit the model and test performance on held-out data using k-fold CV</p></li>
<li><p>Pick the λ that gives the best cross-validated performance</p></li>
</ol>
</section>
<section id="towards-our-implementation-of-regularization" class="level4">
<h4 class="anchored" data-anchor-id="towards-our-implementation-of-regularization">Towards our implementation of regularization</h4>
<p>Regularization can be performed through a variety of software packges, including caret and glmnet. For our first demonstration of regularization via elastic net, we’ll directly use the glmnet package since it provides built-in plotting functions that effectively visualize what the regularization is doing (i.e.&nbsp;how coefficients shrink with increasing λ). After examining these plots, we’ll shift to using caret, which internally calls glmnet but provides a unified framework for comparing different regularization methods and systematically tuning hyperparameters.</p>
<p>Note that glmnet requires the data to be in a specific format:</p>
<ul>
<li><p>A predictor matrix (X)</p></li>
<li><p>A response vector (Y)</p></li>
<li><p>Neither can have missing values</p></li>
</ul>
<p><br><strong>Create the X and Y objects that will be input to glmnet</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>complete_cases <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(analysis_data_158_genes[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"aggressive_disease"</span>, keepr_gene_names)])</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>analysis_df_complete <span class="ot">&lt;-</span> analysis_data_158_genes[complete_cases, ]</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>predictors_complete <span class="ot">&lt;-</span> analysis_df_complete[,<span class="fu">c</span>(<span class="st">"age"</span>, keepr_gene_names)]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictor matrix - glmnet expects a matrix, not data frame</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># "." includes all cols in the df</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># model.matrix adds an intercept column as the first column. We need to remove it, hence [,-1]</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data =</span> predictors_complete)[, <span class="sc">-</span><span class="dv">1</span>]  </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> analysis_df_complete<span class="sc">$</span>aggressive_disease</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Predictor matrix dimensions:"</span>, <span class="fu">dim</span>(X), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Response vector length:"</span>, <span class="fu">length</span>(y), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Number of predictors:"</span>, <span class="fu">ncol</span>(X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predictor matrix dimensions: 900 159 
 Response vector length: 900 
 Number of predictors: 159</code></pre>
</div>
</div>
<p><br><strong>Fit Elastic Net with cross validation</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># for reproducible results</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit elastic net with cross-validation</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha = 1 (LASSO), alpha = 0 (Ridge), alpha = 0.5 (Elastic Net). Alpha controls the mixing ration between Ridge and Lasso regularization. </span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>cv_elastic <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">nfolds =</span> <span class="dv">5</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># make the lambda vs AUC plot</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>)  <span class="co"># Default is c(5, 4, 4, 2) + 0.1</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_elastic, <span class="at">main =</span> <span class="st">"Cross-Validation Curve for Elastic Net"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows prediction error (difference between observed and predicted values) for each set of cross-validation test sets as function of different λ values. The numbers along the top of the plot report the number of predictors that are non-zero at each λ value. The left dashed line reports <strong>λ.min</strong> (the λ value that minimizes cross-validation error and gives the best predictive performance), and the right dashed line reports <strong>λ.1se</strong> (the largest λ value within one standard error of the minimum, which gives a siimpler model with similar performance).</p>
<p>λ.min optimizes for prediction accuracy, while λ.1se follows the “one standard error rule” - choosing the simplest model whose performance is not significantly worse than the best model. In practice, λ.1se often provides better generalization because it reduces overfitting by selecting fewer predictors.</p>
<p>Let’s now compare how these Elastic Net error values and lambda λ compare to regularization via Ridge and LASSO. For this, we’ll switch to accessing regularization tools through the caret package, as, IMO, it is simpler.</p>
<p><br><strong>Compare LASSO, Ridge, and Elastic Net via 5-fold CV and print results</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>n_folds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up cross-validation control</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>train_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> n_folds,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">summaryFunction =</span> twoClassSummary,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the same outcome factor variable and model matrix X variable as we used with glmnet</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> analysis_data_158_genes_clean<span class="sc">$</span>aggressive_disease <span class="co"># must be a 2-level factor variable</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> analysis_data_158_genes_clean[,<span class="fu">c</span>(<span class="st">"age"</span>, keepr_gene_names)]</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">#CV Ridge model:</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>model_ridge <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X, <span class="at">y =</span> y,</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glmnet"</span>, <span class="co"># this is where we specify we want to to glmnet</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> train_control,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">0.001</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">100</span>)), <span class="co"># define alpha and lamda values to test </span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"ROC"</span>) <span class="co">#. use logloss if we want to use deviance based error calculation</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="co">#CV LASSO model:</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>model_lasso <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X, <span class="at">y =</span> y,</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glmnet"</span>, </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> train_control,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">0.001</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">100</span>)),</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"ROC"</span>)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="co"># CV elastic model</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>model_elastic <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X, <span class="at">y =</span> y,</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> train_control,</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">0.001</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">100</span>)),</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"ROC"</span>)</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract ROC of best models. This is also the same as the bestTune model, but model$bestTune only contains hyperparameter values and not ROC</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>ridge_best_roc <span class="ot">&lt;-</span> <span class="fu">max</span>(model_ridge<span class="sc">$</span>results<span class="sc">$</span>ROC)</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>lasso_best_roc <span class="ot">&lt;-</span> <span class="fu">max</span>(model_lasso<span class="sc">$</span>results<span class="sc">$</span>ROC)</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>elastic_best_roc <span class="ot">&lt;-</span> <span class="fu">max</span>(model_elastic<span class="sc">$</span>results<span class="sc">$</span>ROC)</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Get standard errors and SD / sqrt (n-folds)</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>ridge_ROC_se <span class="ot">&lt;-</span> model_ridge<span class="sc">$</span>results<span class="sc">$</span>ROCSD[<span class="fu">which.max</span>(model_ridge<span class="sc">$</span>results<span class="sc">$</span>ROC)] <span class="sc">/</span> <span class="fu">sqrt</span>(n_folds)</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>lasso_ROC_se <span class="ot">&lt;-</span> model_lasso<span class="sc">$</span>results<span class="sc">$</span>ROCSD[<span class="fu">which.max</span>(model_lasso<span class="sc">$</span>results<span class="sc">$</span>ROC)] <span class="sc">/</span> <span class="fu">sqrt</span>(n_folds)</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>elastic_ROC_se <span class="ot">&lt;-</span> model_elastic<span class="sc">$</span>results<span class="sc">$</span>ROCSD[<span class="fu">which.max</span>(model_elastic<span class="sc">$</span>results<span class="sc">$</span>ROC)] <span class="sc">/</span> <span class="fu">sqrt</span>(n_folds)</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Get optimal lambda values</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>ridge_ROC_best_lambda <span class="ot">&lt;-</span> model_ridge<span class="sc">$</span>results<span class="sc">$</span>lambda[<span class="fu">which.max</span>(model_ridge<span class="sc">$</span>results<span class="sc">$</span>ROC)]</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>lasso_ROC_best_lambda <span class="ot">&lt;-</span> model_lasso<span class="sc">$</span>results<span class="sc">$</span>lambda[<span class="fu">which.max</span>(model_lasso<span class="sc">$</span>results<span class="sc">$</span>ROC)]</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>elastic_ROC_best_lambda <span class="ot">&lt;-</span> model_elastic<span class="sc">$</span>results<span class="sc">$</span>lambda[<span class="fu">which.max</span>(model_elastic<span class="sc">$</span>results<span class="sc">$</span>ROC)]</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Get number of non-zero coefficients (need to extract from finalModel)</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="co"># The final model contains the same hyperparameter values as the best cross validated model, but it is trained on the entire dataset</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the final model does contain the models associated with all lambda values. To get the coeffiients associated wih the best performing model, we need to specifiy this model through it's lambda value.</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>ridge_ROC_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_ridge<span class="sc">$</span>finalModel, <span class="at">s =</span> ridge_ROC_best_lambda)</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>lasso_ROC_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_lasso<span class="sc">$</span>finalModel, <span class="at">s =</span> lasso_ROC_best_lambda)</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>elastic_ROC_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_elastic<span class="sc">$</span>finalModel, <span class="at">s =</span> elastic_ROC_best_lambda)</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="co"># get the number of non-zero parameter values for each model</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>ridge_ROC_nonzero <span class="ot">&lt;-</span> <span class="fu">sum</span>(ridge_ROC_coef <span class="sc">!=</span> <span class="dv">0</span>)  </span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>lasso_ROC_nonzero <span class="ot">&lt;-</span> <span class="fu">sum</span>(lasso_ROC_coef <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>elastic_ROC_nonzero <span class="ot">&lt;-</span> <span class="fu">sum</span>(elastic_ROC_coef <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comparison table. Note that ROC and AUC are the same here. </span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>method_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Ridge"</span>, <span class="st">"LASSO"</span>, <span class="st">"Elastic Net"</span>),</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">Best_AUC =</span> <span class="fu">round</span>(<span class="fu">c</span>(ridge_best_roc, lasso_best_roc, elastic_best_roc), <span class="dv">4</span>),</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC_SE =</span> <span class="fu">round</span>(<span class="fu">c</span>(ridge_ROC_se, lasso_ROC_se, elastic_ROC_se), <span class="dv">4</span>),</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">Nonzero_Coefs =</span> <span class="fu">c</span>(ridge_ROC_nonzero, lasso_ROC_nonzero, elastic_ROC_nonzero),</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">Lambda_Min =</span> <span class="fu">round</span>(<span class="fu">c</span>(ridge_ROC_best_lambda, lasso_ROC_best_lambda, </span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>                       elastic_ROC_best_lambda), <span class="dv">6</span>))</span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(method_comparison) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">'striped'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Method</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Best_AUC</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">AUC_SE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Nonzero_Coefs</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Lambda_Min</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Ridge</td>
<td style="text-align: right;">0.7633</td>
<td style="text-align: right;">0.0081</td>
<td style="text-align: right;">160</td>
<td style="text-align: right;">0.122091</td>
</tr>
<tr class="even">
<td style="text-align: left;">LASSO</td>
<td style="text-align: right;">0.7764</td>
<td style="text-align: right;">0.0143</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">0.021182</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Elastic Net</td>
<td style="text-align: right;">0.7771</td>
<td style="text-align: right;">0.0131</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">0.021182</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The table shows that the performance (Best_AUC) of each of the best models produced by the three methods are not statistically different for each other. This is interesting as the models are clearly very different, with different λ min values and number of non-zero coefficients. This might suggest that the simplest model (LASSO), might be best. However, lets keep in mind that LASSO may be arbitrarily choosing predictors from a group of collinear variables. To assess whether the top genes chosen by LASSO are very different than those chosen by the other methods, let’s compare the genes associated with the largest coefficient by each model.</p>
<p><br><strong>Make a table of genes with top coefficients for each model</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coefficients from caret finalModels at optimal lambda values</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>ridge_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_ridge<span class="sc">$</span>finalModel, <span class="at">s =</span> model_ridge<span class="sc">$</span>bestTune<span class="sc">$</span>lambda)[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_lasso<span class="sc">$</span>finalModel, <span class="at">s =</span> model_lasso<span class="sc">$</span>bestTune<span class="sc">$</span>lambda)[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>elastic_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_elastic<span class="sc">$</span>finalModel, <span class="at">s =</span> model_elastic<span class="sc">$</span>bestTune<span class="sc">$</span>lambda)[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top predictors by absolute coefficient value</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>get_top_predictors <span class="ot">&lt;-</span> <span class="cf">function</span>(coef_vector, <span class="at">n =</span> <span class="dv">10</span>) {</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get non-zero coefficients</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  nonzero_coef <span class="ot">&lt;-</span> coef_vector[coef_vector <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by absolute value and take top n</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  top_indices <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">abs</span>(nonzero_coef), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="fu">names</span>(nonzero_coef)[top_indices],</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Coefficient =</span> <span class="fu">round</span>(nonzero_coef[top_indices], <span class="dv">4</span>))}</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Get top 10 for each method</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>ridge_top10 <span class="ot">&lt;-</span> <span class="fu">get_top_predictors</span>(ridge_coef)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>lasso_top10 <span class="ot">&lt;-</span> <span class="fu">get_top_predictors</span>(lasso_coef)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>elastic_top10 <span class="ot">&lt;-</span> <span class="fu">get_top_predictors</span>(elastic_coef)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comparison table with equal length columns</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>max_rows <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">nrow</span>(ridge_top10), <span class="fu">nrow</span>(lasso_top10), <span class="fu">nrow</span>(elastic_top10))</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into comparison table</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>predictor_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ridge_Variable =</span> ridge_top10<span class="sc">$</span>Variable,</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ridge_Coef =</span> ridge_top10<span class="sc">$</span>Coefficient,</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">LASSO_Variable =</span> lasso_top10<span class="sc">$</span>Variable,</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">LASSO_Coef =</span> lasso_top10<span class="sc">$</span>Coefficient,</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">Elastic_Variable =</span> elastic_top10<span class="sc">$</span>Variable,</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">Elastic_Coef =</span> elastic_top10<span class="sc">$</span>Coefficient)</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the table</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(predictor_comparison, </span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Top 10 Predictors by Regularization Method (Ranked by |Coefficient|)"</span>,</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Coefficient"</span>, <span class="st">"Variable"</span>, <span class="st">"Coefficient"</span>, <span class="st">"Variable"</span>, <span class="st">"Coefficient"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">'striped'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"Ridge"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"LASSO"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"Elastic Net"</span> <span class="ot">=</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<caption>Top 10 Predictors by Regularization Method (Ranked by |Coefficient|)</caption>
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th colspan="2" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Ridge
</div></th>
<th colspan="2" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
LASSO
</div></th>
<th colspan="2" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Elastic Net
</div></th>
</tr>
<tr class="even">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Coefficient</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Coefficient</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Coefficient</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ESR1</td>
<td style="text-align: right;">-0.0659</td>
<td style="text-align: left;">ESR1</td>
<td style="text-align: right;">-0.2115</td>
<td style="text-align: left;">ESR1</td>
<td style="text-align: right;">-0.1834</td>
</tr>
<tr class="even">
<td style="text-align: left;">SLC27A2</td>
<td style="text-align: right;">-0.0581</td>
<td style="text-align: left;">FSIP1</td>
<td style="text-align: right;">-0.0588</td>
<td style="text-align: left;">FSIP1</td>
<td style="text-align: right;">-0.0758</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ADAMTS16</td>
<td style="text-align: right;">-0.0526</td>
<td style="text-align: left;">CLIC6</td>
<td style="text-align: right;">-0.0532</td>
<td style="text-align: left;">SLC27A2</td>
<td style="text-align: right;">-0.0742</td>
</tr>
<tr class="even">
<td style="text-align: left;">FSIP1</td>
<td style="text-align: right;">-0.0518</td>
<td style="text-align: left;">SLC27A2</td>
<td style="text-align: right;">-0.0513</td>
<td style="text-align: left;">FMO2</td>
<td style="text-align: right;">0.0734</td>
</tr>
<tr class="odd">
<td style="text-align: left;">COL9A3</td>
<td style="text-align: right;">0.0506</td>
<td style="text-align: left;">TPRG1</td>
<td style="text-align: right;">-0.0511</td>
<td style="text-align: left;">ADAMTS16</td>
<td style="text-align: right;">-0.0694</td>
</tr>
<tr class="even">
<td style="text-align: left;">CLIC6</td>
<td style="text-align: right;">-0.0500</td>
<td style="text-align: left;">COL9A3</td>
<td style="text-align: right;">0.0449</td>
<td style="text-align: left;">CLIC6</td>
<td style="text-align: right;">-0.0674</td>
</tr>
<tr class="odd">
<td style="text-align: left;">FMO2</td>
<td style="text-align: right;">0.0498</td>
<td style="text-align: left;">ADAMTS16</td>
<td style="text-align: right;">-0.0404</td>
<td style="text-align: left;">COL9A3</td>
<td style="text-align: right;">0.0639</td>
</tr>
<tr class="even">
<td style="text-align: left;">CXCL14</td>
<td style="text-align: right;">-0.0429</td>
<td style="text-align: left;">CXCL14</td>
<td style="text-align: right;">-0.0345</td>
<td style="text-align: left;">CXCL14</td>
<td style="text-align: right;">-0.0523</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MAPT</td>
<td style="text-align: right;">-0.0407</td>
<td style="text-align: left;">MAPT</td>
<td style="text-align: right;">-0.0273</td>
<td style="text-align: left;">TPRG1</td>
<td style="text-align: right;">-0.0490</td>
</tr>
<tr class="even">
<td style="text-align: left;">NELL2</td>
<td style="text-align: right;">0.0392</td>
<td style="text-align: left;">WFDC2</td>
<td style="text-align: right;">-0.0153</td>
<td style="text-align: left;">TF</td>
<td style="text-align: right;">-0.0424</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The table shows that the top predictor variables are largely the same across the three methods. There are some differences in ordering, but this makes me feel more confident that the LASSO (and to a lesser extent Elastic net) are not arbitrarily choosing inferior predictors that may be unstable or perform poorly on new datasets.</p>
<p>As a final comparison of these regularized models, let’s compare AUC values from cross-validation to assess both predictive performance and overfitting. This will give us a better sense of how well regularization solved our overfitting problem. We’ll include our previous models for comparison, and for each we will plot the AUC for each of 10 CV test sets, as well as the performance of the best model on the training dataset.</p>
<p><br><strong>Plot AUCs for each test-fold for all models</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set for 10-fold CV</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>train_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> <span class="dv">10</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">classProbs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">summaryFunction =</span> twoClassSummary,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co"># First, do k-fold cross validation on the esr1 only model</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>formula_string <span class="ot">&lt;-</span> <span class="st">"aggressive_disease ~ age + PGR"</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>pgr_only_model_cv <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(formula_string),</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> analysis_data_158_genes_clean,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"glm"</span>,</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="co"># For a logistic regression model</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> train_control,</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"ROC"</span>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Get all individual ROC values from performance on k test sets</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>ridge_all_AUC <span class="ot">&lt;-</span> model_ridge<span class="sc">$</span>resample<span class="sc">$</span>ROC</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>lasso_all_AUC <span class="ot">&lt;-</span> model_lasso<span class="sc">$</span>resample<span class="sc">$</span>ROC  </span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>elastic_all_AUC <span class="ot">&lt;-</span> model_elastic<span class="sc">$</span>resample<span class="sc">$</span>ROC</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>model_158_all_AUC <span class="ot">&lt;-</span> model_158_gene_cv<span class="sc">$</span>resample<span class="sc">$</span>ROC</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>pgr_all_AUC <span class="ot">&lt;-</span> pgr_only_model_cv<span class="sc">$</span>resample<span class="sc">$</span>ROC</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="co"># get in-sample AUCs for each model</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>get_training_set_roc <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>  train_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="st">"aggressive"</span>]</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>  train_roc <span class="ot">&lt;-</span> <span class="fu">roc</span>(y, train_predictions)</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>  train_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(train_roc)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (train_auc)}</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>Ridge_insample_AUC <span class="ot">&lt;-</span> <span class="fu">get_training_set_roc</span>(model_ridge)</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>LASSO_insample_AUC <span class="ot">&lt;-</span> <span class="fu">get_training_set_roc</span>(model_lasso)</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>Elastic_insample_AUC <span class="ot">&lt;-</span> <span class="fu">get_training_set_roc</span>(model_elastic)</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>genes158_insample_AUC <span class="ot">&lt;-</span> <span class="fu">get_training_set_roc</span>(model_158_gene_cv)</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>pgr_insample_AUC <span class="ot">&lt;-</span> <span class="fu">get_training_set_roc</span>(pgr_only_model_cv)</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a><span class="co"># put training data into a tidy df</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>train_data_AUCs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"Ridge"</span>, <span class="st">"LASSO"</span>, <span class="st">"Elastic"</span>, <span class="st">"model_158_genes"</span>, <span class="st">"pgr_only"</span>),</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUC =</span> <span class="fu">c</span>(Ridge_insample_AUC, LASSO_insample_AUC, Elastic_insample_AUC, genes158_insample_AUC, pgr_insample_AUC),</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">Assessment =</span> <span class="st">'in_sample'</span>)</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a><span class="co"># put test into df  (wide)</span></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>test_data_AUCs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ridge =</span> ridge_all_AUC,</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">LASSO =</span> lasso_all_AUC,</span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">Elastic =</span> elastic_all_AUC,</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_158_genes =</span> model_158_all_AUC,</span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">pgr_only =</span> pgr_all_AUC)</span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a><span class="co"># pivot the test data so it can be merged with the training perf. data</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>test_data_AUCs_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(test_data_AUCs, <span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">'method'</span>, <span class="at">values_to =</span> <span class="st">"AUC"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="st">'Assessment'</span> <span class="ot">=</span> <span class="st">'test data'</span>)</span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the two dfs</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(test_data_AUCs_long, train_data_AUCs)</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x=</span>method, <span class="at">y=</span>AUC, <span class="at">color=</span>Assessment)) <span class="sc">+</span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>, <span class="at">height =</span> <span class="dv">0</span>, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span>  <span class="co"># Add jitter horizontally only</span></span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> median, <span class="at">geom =</span> <span class="st">"crossbar"</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">fatten =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure clearly demonstrates that all three regularization methods successfully address the severe overfitting problem seen in the unregularized 158-gene model. While the 158-gene model shows a large gap between training performance (AUC ~0.90) and test performance (AUC ~0.71), all three regularized methods substantially reduce this overfitting. However, Ridge regression still exhibits moderate signs of overfitting compared to LASSO and Elastic Net. The Ridge training AUC (~0.85) consistently exceeds its test performance (~0.78), and it displays notably higher variability across test folds. In contrast, LASSO and Elastic Net show minimal gaps between training and test performance and much tighter clustering of test results around their medians. Interestingly, the pgr-only model, despite its simplicity, shows high variability in test performance across folds, ranging from approximately 0.61 to 0.78 AUC, suggesting that even simple models can be unstable when the underlying signal is weak or when the dataset has inherent variability in the relationships between predictors and outcomes.</p>
<p>Lastly, let’s compare these model’s ROC curves.</p>
<p><br><strong>Plot ROC curves for all models</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to get the roc df for each model</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>get_pooled_roc <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">model_name =</span> <span class="st">"Model"</span>) {</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract all test predictions from cross-validation</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  all_predictions <span class="ot">&lt;-</span> model<span class="sc">$</span>pred</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># each all_predictions object has observed and predicted values. It also has lambda values and if the model is an elastic net, it also has alpha values. </span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter to best hyperparameters</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">"lambda"</span> <span class="sc">%in%</span> <span class="fu">names</span>(model<span class="sc">$</span>bestTune)) {</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For glmnet models</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    all_predictions <span class="ot">&lt;-</span> all_predictions[all_predictions<span class="sc">$</span>lambda <span class="sc">==</span> model<span class="sc">$</span>bestTune<span class="sc">$</span>lambda, ]</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="st">"alpha"</span> <span class="sc">%in%</span> <span class="fu">names</span>(model<span class="sc">$</span>bestTune)) {</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>      all_predictions <span class="ot">&lt;-</span> all_predictions[all_predictions<span class="sc">$</span>alpha <span class="sc">==</span> model<span class="sc">$</span>bestTune<span class="sc">$</span>alpha, ]</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate pooled ROC curve</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  pooled_roc <span class="ot">&lt;-</span> <span class="fu">roc</span>(all_predictions<span class="sc">$</span>obs, all_predictions<span class="sc">$</span>aggressive)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  roc_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">model =</span> model_name, <span class="at">specificity =</span> <span class="fu">rev</span>(pooled_roc<span class="sc">$</span>specificities), </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">tpr =</span> <span class="fu">rev</span>(pooled_roc<span class="sc">$</span>sensitivities))</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return ROC object with model name</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(roc_df)}</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function for all models</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>ridge_pooled_roc <span class="ot">&lt;-</span> <span class="fu">get_pooled_roc</span>(model_ridge, <span class="st">"Ridge"</span>)</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>lasso_pooled_roc <span class="ot">&lt;-</span> <span class="fu">get_pooled_roc</span>(model_lasso, <span class="st">"LASSO"</span>) </span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>elastic_pooled_roc <span class="ot">&lt;-</span> <span class="fu">get_pooled_roc</span>(model_elastic, <span class="st">"Elastic Net"</span>)</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>model_158_pooled_roc <span class="ot">&lt;-</span> <span class="fu">get_pooled_roc</span>(model_158_gene_cv, <span class="st">"158-gene"</span>)</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>pgr_pooled_roc <span class="ot">&lt;-</span> <span class="fu">get_pooled_roc</span>(pgr_only_model_cv, <span class="st">"PGR only"</span>)</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="co"># combine all the data</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(ridge_pooled_roc, lasso_pooled_roc, elastic_pooled_roc, </span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>                 model_158_pooled_roc,pgr_pooled_roc)</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df, <span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">-</span>specificity, <span class="at">y=</span>tpr, <span class="at">color=</span>model)) <span class="sc">+</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth=</span><span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">'FPR'</span>, <span class="at">y=</span><span class="st">'TPR'</span>) <span class="sc">+</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="GLM_tutorial_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ROC plots shows all three regularized models performing better than single gene and 158-gene models, as expected. Given these data and that from the scatterplot above, I would likely choose either the Elastic Net or the LASSO model for prediction, as these will give more consistent performance on test data sets.</p>
</section>
<section id="conclusion" class="level4">
<h4 class="anchored" data-anchor-id="conclusion">Conclusion</h4>
<p>This analysis demonstrates the power and necessity of regularization in high-dimensional genomics data. The unregularized 158-gene model, despite achieving impressive training performance (AUC ~0.90), suffered from severe overfitting that rendered it unreliable for new predictions. Regularization methods successfully solved this problem, with LASSO and Elastic Net emerging as the optimal approaches due to their combination of strong predictive performance (~0.78 AUC) and excellent generalization stability. While Ridge regression achieved similar average performance, its higher variability across test folds makes it less suitable for clinical deployment where consistent predictions are crucial. The comparison also revealed that simple models like the single-gene approach, while interpretable, sacrifice substantial predictive power and can exhibit unexpected instability.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>